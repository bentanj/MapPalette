<!-- TODO:
4. trending route -> when map clicked goes to route page with modal of map opened?
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapPalette Homepage</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- homepage CSS -->
    <link rel="stylesheet" href="homepage_style.css">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Firebase -->
    <script type="module" src="firebase.js"></script>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- axios-->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    
    <script>
        // Use the global `currentUser` after Firebase initializes
        document.addEventListener('DOMContentLoaded', () => {
            // Check if currentUser is already available
            if (window.currentUser) {
                console.log("Current user data:", window.currentUser);
            } else {
                // Set up a listener for auth state changes in case user data loads later
                const checkAuthInterval = setInterval(() => {
                    if (window.currentUser !== null) {
                        console.log("Current user data:", window.currentUser);
                        clearInterval(checkAuthInterval);  // Stop checking once data is available
                    }
                }, 1000);
            }
        });
    </script>

</head>
    
<body>
    <div id="app">
        <!-- Navbar -->
        <nav-bar :user_profile="userProfile"></nav-bar>

        <div class="main-content-wrapper">
            <!-- Hero Section -->
            <section class="hero-section">
                <div class="hero-background"></div>
                <div class="hero-overlay"></div>
                <div class="container">
                    <div class="hero-content">
                        <h1>Running Community Feed</h1>
                        <p>Stay inspired by fellow runners' achievements, discover popular routes, and share your running journey.</p>
                        <div class="hero-stats">
                            <div v-for="stat in heroStats" :key="stat.id" class="stat-item">
                                <i :class="stat.icon"></i>
                                <span>{{ stat.text }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- main content -->
            <div class="container-fluid">
                <div class="row">
                    <!-- Left sidebar -->
                    <div class="col-lg-3 col-md-4">
                        <div class="side-column bg-white p-4 rounded shadow-sm">
                            <!-- Profile Summary -->
                            <div class="mb-4 pb-3 border-bottom">
                                <div class="d-flex align-items-center mb-3">
                                    <img :src="userProfile.avatar" alt="Profile" class="rounded-circle me-3" 
                                        style="width: 50px; height: 50px; object-fit: cover;">
                                    <div>
                                        <h6 class="mb-0 fw-bold">{{ userProfile.name }}</h6>
                                        <small class="text-muted">{{ userProfile.username }}</small>
                                    </div>
                                </div>
                                <div class="row text-center g-2">
                                    <div class="col-4" v-for="(value, key) in userProfile.stats" :key="key">
                                        <div class="p-2 border rounded">
                                            <div class="fw-bold">{{ value }}</div>
                                            <small class="text-muted">{{ key }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    
                            <!-- Quick Actions -->
                            <div class="mb-4 pb-3 border-bottom">
                                <h6 class="mb-3 text-uppercase fw-bold text-muted small">Quick Actions</h6>
                                <a href="addMaps.html" class="btn btn-primary w-100 mb-2">
                                    <i class="bi bi-map me-2"></i>
                                    Draw Your Map!
                                </a>
                                <a href="routes.html" class="btn btn-outline-secondary w-100">
                                    <i class="bi bi-search me-2"></i>
                                    Browse Routes
                                </a>
                            </div>
                    
                            <!-- Navigation Menu -->
                            <div class="mb-4">
                                <h6 class="mb-3 text-uppercase fw-bold text-muted small">Menu</h6>
                                <div class="list-group list-group-flush">
                                    <a v-for="item in menuItems" 
                                    :key="item.id" 
                                    href="#" 
                                    class="list-group-item list-group-item-action d-flex align-items-center">
                                        <i :class="item.icon + ' me-3'"></i>
                                        {{ item.text }}
                                    </a>
                                </div>
                            </div>
                    
                            <!-- Trending Routes -->
                            <div>
                                <h6 class="mb-3 text-uppercase fw-bold text-muted small">Trending Routes</h6>
                                <div v-for="route in trendingRoutes" 
                                    :key="route.id" 
                                    class="card mb-2 hover-overlay"
                                    @click="viewRoute(route)">
                                    <img :src="route.image" class="card-img-top" alt="Route preview" 
                                        style="height: 100px; object-fit: cover;">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1">{{ route.title }}</h6>
                                        <p class="card-text small text-muted mb-0">{{ route.distance }} â€¢ {{ route.saves }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main content area using vue components -->
                    <div class="col-lg-8 col-md-8 content">
                        <div id="activity-feed">
                            <activity-card
                                v-for="activity in activities"
                                :key="activity.id"
                                :activity="activity"
                                :current-user="currentUser"
                                @like="likeActivity"
                                @open-modal="openActivityModal"
                                @edit="handleActivityEdit">
                            </activity-card>
                        </div>
                    </div>

                    <!-- Updated modal component -->
                    <comment-modal
                        v-if="selectedActivity"
                        :activity="selectedActivity"
                        @close="selectedActivity = null"
                        @like="likeActivity"
                    ></comment-modal>
                </div>
            </div>
        </div>

        <!-- Footer Section -->
        <site-footer></site-footer>

    </div>
    

        <!-- Initial Vue app setup -->
    <script>

        const { createApp } = Vue

        // ActivityCard Component
        const ActivityCard = {
        props: {
            activity: {
                type: Object,
                required: true
            },
            currentUser: {  
                type: String,
                required: true
            }
        },
        computed: {
            isLiked() {
                return this.activity.isLiked || false;
            },
            isOwnPost() {  
                return this.currentUser === this.activity.user;
            }
        },
        methods: {
            handleEdit() {
                window.location.href = `addMaps.html?id=${this.activity.id}`;
            },
            useRoute() {
                window.location.href = `addMaps.html?id=${this.activity.id}`;
            },
            handleShare() {
                window.location.href = `homepage.html?id=${this.activity.id}`;
            }
        },
        template: `
            <article class="post">
                <!-- d header -->
                <header>
                    <div class="title">
                        <div class="d-flex justify-content-between align-items-start">
                            <h2>{{ activity.title }}</h2>
                            <!-- Add dropdown menu -->
                            <div v-if="isOwnPost" class="dropdown">
                                <button class="btn btn-link text-dark p-0" 
                                        type="button" 
                                        data-bs-toggle="dropdown" 
                                        aria-expanded="false"
                                        @click.stop>
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <button class="dropdown-item" @click.stop="handleEdit">
                                            <i class="fas fa-edit me-2"></i>Edit Post
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <p>{{ activity.user }}</p>
                    </div>
                    <div class="meta">
                        <time class="published">{{ activity.date }}</time>
                        <div class="d-flex align-items-center justify-content-end mt-2">
                            <span class="me-2">{{ activity.user }}</span>
                            <img :src="activity.userImg" alt="Profile" class="rounded-circle" 
                                style="width: 40px; height: 40px; object-fit: cover;">
                        </div>
                    </div>
                </header>
                
                
                <div class="image featured" @click="$emit('open-modal', activity)">
                    <img :src="activity.mapImg" alt="Activity Map">
                </div>
                
                <div class="content">
                    <div class="d-flex justify-content-between text-center mb-3">
                        <div>
                            <h6 class="mb-0 fw-bold">{{ activity.distance }}</h6>
                            <small class="text-muted">Distance</small>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">{{ activity.time }}</h6>
                            <small class="text-muted">Time</small>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="flex-grow-1">
                            <p v-if="activity.description" class="mb-0">{{ activity.description }}</p>
                        </div>
                        <div class="d-flex ms-3">
                            <div class="me-3">
                                <small class="text-muted"><i class="bi bi-geo-alt"></i> {{ activity.location }}</small>
                            </div>
                            <div class="me-3">
                                <small class="text-muted"><i class="bi bi-heart"></i> {{ activity.likes || 0 }}</small>
                            </div>
                            <div>
                                <small class="text-muted"><i class="bi bi-chat"></i> {{ activity.comments ? activity.comments.length : 0 }}</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- start of footer -->
                <footer>
                    <div class="actions">
                        <div class="d-flex justify-content-between border-top border-bottom py-3">
                            <button
                                class="btn btn-link p-0 action-button"
                                @click.stop="$emit('like', activity)"
                                :class="{ 'liked': isLiked }"
                                :disabled="activity.likeDisabled">
                                <i :class="[isLiked ? 'fas' : 'far', 'fa-thumbs-up me-1']"></i>
                                <span>Like</span>
                            </button>
                            <button
                                class="btn btn-link p-0 action-button"
                                @click.stop="$emit('open-modal', activity)">
                                <i class="far fa-comment me-1"></i>
                                <span>Comment</span>
                            </button>
                            <button
                                class="btn btn-link p-0 action-button"
                                @click.stop="useRoute">
                                <i class="far fa-map me-1"></i>
                                <span>Use</span>
                            </button>
                            <button
                                class="btn btn-link p-0 action-button"
                                @click.stop="handleShare">
                                <i class="far fa-share-square me-1"></i>
                                <span>Share</span>
                            </button>
                        </div>
                    </div>
                </footer>
            </article>`
        }

        // CommentModal Component
        const CommentModal = {
                props: {
                    activity: {
                        type: Object,
                        required: true
                    }
                },

                data() {
                    return {
                        newComment: '',
                        modal: null,
                        showAllComments: false,
                        disabledActions: {},
                        lastApiCallTime: 0
                    }
                },

                computed: {
                    isLiked() {
                        return this.activity.isLiked || false;
                    }
                },

                mounted() {
                    this.modal = new bootstrap.Modal(this.$el)
                    this.modal.show()
                    this.$el.addEventListener('hidden.bs.modal', () => {
                        this.$emit('close')
                    })
                },

                methods: {

                    useRoute() {
                        window.location.href = `addMaps.html?id=${this.activity.id}`;
                    },
                    handleShare() {
                        window.location.href = `homepage.html?id=${this.activity.id}`;
                    },

                    submitComment() {
                        if (!this.newComment.trim()) return;

                        const currentTime = Date.now();
                        if (currentTime - this.lastApiCallTime < 1000) {
                            alert('Please wait a moment before performing another action.');
                            return;
                    }

                    this.lastApiCallTime = currentTime;
                    this.disabledActions.comment = true;

                    if (!this.activity.comments) {
                        this.activity.comments = [];
                    }
                    
                    this.activity.comments.push({
                        name: 'You',
                        text: this.newComment
                    });
                    
                    this.newComment = '';

                    setTimeout(() => {
                        this.disabledActions.comment = false;
                    }, 1000);
                },

                toggleShowAllComments() {
                    this.showAllComments = !this.showAllComments;
                },

                limitedComments() {
                    if (this.showAllComments) {
                        return this.activity.comments;
                    } else {
                        return this.activity.comments ? this.activity.comments.slice(0, 4) : [];
                    }
                },
                
            },

            template: `
                <div class="modal fade" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <!-- Modal Header -->
                        <div class="modal-header d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="modal-title" :id="'modalLabel'">{{ activity.title }}</h5>
                                <h6 class="modal-author text-muted">by {{ activity.user }}</h6>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <!-- Modal Body -->
                        <div class="modal-body">
                            <div id="modal-pic">
                                <img :src="activity.mapImg" alt="Activity Map" class="img-fluid">
                            </div>

                            <!-- Modal Content -->
                            <p class="text-muted">Posted {{ activity.date }}</p>
                            <p class="text-muted">{{ activity.likes || 0 }} Likes | {{ activity.comments ? activity.comments.length : 0 }} Comments</p>
                            
                            <!-- Stats Row -->
                            <div class="d-flex mb-3">
                                <p class="me-4"><strong>Distance:</strong> {{ activity.distance }}</p>
                                <p><strong>Time:</strong> {{ activity.time }}</p>
                            </div>
                            
                            <p>{{ activity.description }}</p>

                            <!-- Action Buttons -->
                            <div class="d-flex border-top border-bottom py-3">
                                <div class="d-flex w-100 px-4" style="justify-content: space-between; padding-left: 20% !important; padding-right: 20% !important;">
                                    <button class="btn btn-link p-0 action-button" 
                                            @click="$emit('like', activity)"
                                            :class="{ 'liked': isLiked }"
                                            :disabled="activity.likeDisabled">
                                        <i :class="[isLiked ? 'fas' : 'far', 'fa-thumbs-up me-1']"></i>
                                        <span>Like</span>
                                    </button>

                                    <button class="btn btn-link p-0 action-button"
                                            @click="useRoute"
                                            :disabled="disabledActions.use">
                                        <i class="far fa-map me-1"></i>
                                        <span>Use</span>
                                    </button>

                                    <button class="btn btn-link p-0 action-button"
                                            @click="handleShare"
                                            :disabled="disabledActions.share">
                                        <i class="far fa-share-square me-1"></i>
                                        <span>Share</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Comments Section -->
                            <br>
                            <h6>Comments</h6>
                            <div class="mb-3">
                                <textarea class="form-control mb-2"
                                        placeholder="Add a comment..."
                                        rows="2"
                                        v-model="newComment"></textarea>
                                <button class="btn btn-primary"
                                        @click="submitComment"
                                        :disabled="disabledActions.comment">
                                    <span v-if="!disabledActions.comment">Post Comment</span>
                                    <span v-else><i class="fas fa-spinner fa-spin"></i> Posting...</span>
                                </button>
                            </div>

                            <ul class="list-unstyled">
                                <li v-for="comment in limitedComments()" class="mb-2">
                                    <strong>{{ comment.name }}:</strong> {{ comment.text }}
                                </li>
                            </ul>

                            <button v-if="activity.comments && activity.comments.length > 4"
                                    @click="toggleShowAllComments"
                                    class="btn btn-link p-0">
                                {{ showAllComments ? 'Show Less Comments' : 'Load More Comments' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>`
        }

        // vue app with axios data fetching
        const app = createApp({
            components: {
                ActivityCard,
                CommentModal, 
            },
            data() {
                return {
                    currentUser: '',
                    selectedActivity: null,
                    lastApiCallTime: 0,
                    userProfile: {
                        name: '',
                        username: '',
                        avatar: '',
                        stats: {
                            routes: 0,
                            following: 0,
                            followers: 0
                        }
                    },
                    heroStats: [
                        { 
                            id: 1, 
                            icon: 'bi bi-people-fill', 
                            text: '2.5k Active Runners' 
                        },
                        { 
                            id: 2, 
                            icon: 'bi bi-map-fill', 
                            text: '500+ Shared Routes' 
                        },
                        { 
                            id: 3, 
                            icon: 'bi bi-trophy-fill', 
                            text: 'Daily Achievements' 
                        }
                    ],
                    menuItems: [
                        { 
                            id: 1, 
                            icon: 'bi bi-activity', 
                            text: 'My Activities', 
                            route: 'activities' 
                        },
                        { 
                            id: 2, 
                            icon: 'bi bi-map', 
                            text: 'Saved Routes', 
                            route: 'saved-routes' 
                        },
                        { 
                            id: 3, 
                            icon: 'bi bi-trophy', 
                            text: 'Challenges', 
                            route: 'challenges' 
                        }
                    ],
                    trendingRoutes: [],
                    activities: []
                }
            },

            created() {
                // axios user and post data
                const postsPromise = axios.get('databaseTemplateFolder/postTemplate.json');
                const usersPromise = axios.get('databaseTemplateFolder/userTemplate.json');

                Promise.all([postsPromise, usersPromise])
                    .then(([postsResponse, usersResponse]) => {
                        const posts = postsResponse.data.posts;
                        const users = usersResponse.data.users;

                        // assume user1 nw
                        const user1 = users[0];  
                        this.currentUser = user1.username;

                        // user profile
                        this.userProfile = {
                            name: user1.username,
                            username: `@${user1.username}`,
                            avatar: user1.profilePicture,
                            stats: {
                                routes: user1.postsCreated.length,
                                following: user1.numFollowed || user1.followed.length,
                                followers: user1.numFollowers || user1.followers.length
                            }
                        };

                        // user1
                        this.activities = posts.map(post => {
                            const runTitles = "Morning Run";

                            return {
                                id: post.postID,
                                user: user1.username,
                                userImg: user1.profilePicture,
                                date: new Date(post.createdAt).toLocaleString('en-US', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }),
                                location: post.waypoints[0].address,

                                // hard code
                                title: runTitles,
                                routeTitle: post.title,
                                description: post.description,
                                distance: `${post.distance} km`,
                                time: "N/A",
                                mapImg: post.image,
                                likes: post.likeCount,
                                comments: [],
                                isLiked: user1.postsLiked.some(liked => liked.postID === post.postID)
                            };
                        });

                        // Sort posts by date for feed
                        this.activities.sort((a, b) => new Date(b.date) - new Date(a.date));

                        // Set trending routes (most liked posts)
                        this.trendingRoutes = posts
                            .sort((a, b) => b.likeCount - a.likeCount)
                            .slice(0, 2)
                            .map(post => ({
                                id: post.postID,
                                title: post.title,
                                distance: `${post.distance} km`,
                                saves: `${post.shareCount} saves this week`,
                                image: post.image
                            }));
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    }
                );
            },

            methods: {
                openActivityModal(activity) {
                    this.selectedActivity = activity;
                },
                
                likeActivity(activity) {
                    activity.likeDisabled = true;
                    if (!activity.isLiked) {
                        if (!activity.likes) activity.likes = 0;
                        activity.likes++;
                        activity.isLiked = true;
                    } else {
                        activity.likes--;
                        activity.isLiked = false;
                    }
                    setTimeout(() => {
                        activity.likeDisabled = false;
                    }, 1000);
                }
            }
        });
    </script>

    <!-- import navbar from navbar.js -->
    <script src="navbar/navbar.js"></script>

    <!-- import footer from footer.js -->
    <script src="footer/footer.js"></script>

    <script>
        app.mount('#app')
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>