<!-- TODO:
2. need to implement limit as to how many comments can show on the modal?
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapPalette Homepage</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- homepage CSS -->
    <link rel="stylesheet" href="homepage_style.css">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Firebase -->
    <script type="module" src="firebase.js"></script>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- axios-->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
    
<body>
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Main Content, Hidden Initially -->
    <div id="app-container" style="display: none;">
        <div id="app">
        <!-- Navbar -->
        <nav-bar :user_profile="userProfile"></nav-bar>
        
        <!-- alert -->
        <div class="alert alert-dismissible fade" 
            :class="{'alert-warning': alertType === 'error', 'alert-success': alertType === 'success', 'show': showAlert}"
            :hidden="hidden" 
            role="alert">
            <!-- Icons for Error or Success -->
            <svg v-if="alertType === 'error'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
            </svg>
            <svg v-if="alertType === 'success'" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
            <!-- Alert Message -->
            {{ alertMessage }}
            <!-- Close Button -->
            <button type="button" class="btn-close" @click="dismissAlert()"></button>
        </div>

        <div class="main-content-wrapper">
            <!-- Hero Section -->
            <section class="hero-section">
                <div class="hero-background"></div>
                <div class="hero-overlay"></div>
                <div class="container">
                    <div class="hero-content">
                        <h1>Running Community Feed</h1>
                        <p>Stay inspired by fellow runners' achievements, discover popular routes, and share your running journey.</p>
                        <div class="hero-stats">
                            <div v-for="stat in heroStats" :key="stat.id" class="stat-item">
                                <i :class="stat.icon"></i>
                                <span>{{ stat.text }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- main content -->
            <div class="container-fluid">
                <div class="row">
                    <!-- Left sidebar -->
                    <div class="col-lg-3 col-md-4">
                        <div class="side-column bg-white p-4 rounded shadow-sm">
                            <!-- Profile Summary -->
                            <div class="mb-4 pb-3 border-bottom">
                                <div class="d-flex align-items-center mb-3">
                                    <img :src="userProfile.avatar" alt="Profile" class="rounded-circle me-3" 
                                        style="width: 50px; height: 50px; object-fit: cover;">
                                    <div>
                                        <h6 class="mb-0 fw-bold">{{ userProfile.name }}</h6>
                                        <small class="text-muted">{{ userProfile.username }}</small>
                                    </div>
                                </div>
                                <div class="row text-center g-2">
                                    <div class="col-4" v-for="(value, key) in userProfile.stats" :key="key">
                                        <div class="p-2 border rounded">
                                            <div class="fw-bold">{{ value }}</div>
                                            <small class="text-muted">{{ key }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    
                            <!-- Quick Actions -->
                            <div class="mb-4 pb-3 border-bottom">
                                <h6 class="mb-3 text-uppercase fw-bold text-muted small">Quick Actions</h6>
                                <a href="addMaps.html" class="btn btn-primary w-100 mb-2">
                                    <i class="bi bi-map me-2"></i>
                                    Draw Your Map!
                                </a>
                                <a href="routes.html" class="btn btn-outline-secondary w-100">
                                    <i class="bi bi-search me-2"></i>
                                    Browse Routes
                                </a>
                            </div>
                    
                            <!-- Navigation Menu -->
                            <div class="mb-4">
                                <h6 class="mb-3 text-uppercase fw-bold text-muted small">Menu</h6>
                                <div class="list-group list-group-flush">
                                    <a v-for="item in menuItems" 
                                    :key="item.id" 
                                    :href="item.route" 
                                    class="list-group-item list-group-item-action d-flex align-items-center">
                                        <i :class="item.icon + ' me-3'"></i>
                                        {{ item.text }}
                                    </a>
                                </div>
                            </div>

                            <!-- Suggested Followers (shown when user has no following) -->
                            <div v-if="userProfile.stats.following === 0" class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-uppercase fw-bold text-muted small mb-0">Suggested Runners</h6>
                                    <div>
                                        <button @click="loadSuggestedUsers" 
                                                class="btn btn-link btn-sm text-decoration-none p-0 me-2">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        <a href="friends.html" class="text-decoration-none small">See All</a>
                                    </div>
                                </div>
                                <div v-if="suggestedUsers.length > 0">
                                    <div v-for="user in suggestedUsers" :key="user.userID" class="mb-3 p-2 border rounded hover-shadow">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <img :src="user.profilePicture || 'resources/default-profile.png'" 
                                                    :alt="user.username"
                                                    class="rounded-circle me-2"
                                                    style="width: 40px; height: 40px; object-fit: cover;">
                                                <div>
                                                    <h6 class="mb-0 small">{{ user.username }}</h6>
                                                </div>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <!-- Follow Button -->
                                                <button class="btn btn-outline-primary btn-sm"
                                                        v-if="!user.isFollowing"
                                                        @click="followUser(user)">
                                                    <i class="bi bi-person-plus"></i>
                                                    Follow
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div v-else class="text-center py-3">
                                    <p class="text-muted small mb-0">Loading suggestions...</p>
                                </div>
                            </div>

                            <!-- Trending Routes Section - Only shown for existing users -->
                            <div v-if="userProfile.stats.following > 0 && trendingRoutes.length > 0">
                                <h6 class="mb-3 text-uppercase fw-bold text-muted small">Trending Routes</h6>
                                <div v-for="route in trendingRoutes" 
                                    :key="route.id" 
                                    class="card mb-2 hover-overlay"
                                    @click="viewRoute(route)">
                                    <img :src="route.image" class="card-img-top" alt="Route preview" 
                                        style="height: 100px; object-fit: cover;">
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1">{{ route.title }}</h6>
                                        <p class="card-text small text-muted mb-0">{{ route.distance }} • {{ route.saves }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main content area using vue components -->
                    <div class="col-lg-8 col-md-8 content">
                        <!-- New User Tutorial Section (show only if user has no friends/routes) -->
                        <div v-if="isNewUser && (!activities || activities.length === 0)" class="mb-4">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h3 class="card-title mb-4">👋 Welcome to MapPalette!</h3>
                                    <p class="card-text">Here's how to get started:</p>
                                    
                                    <div class="getting-started-steps">
                                        <div class="step d-flex align-items-start mb-4">
                                            <div class="step-icon me-3">
                                                <i class="bi bi-1-circle-fill fs-4 text-primary"></i>
                                            </div>
                                            <div>
                                                <h5>Draw Your First Route</h5>
                                                <p>Create your first running route by clicking "Draw Your Map!" in the quick actions menu.</p>
                                                <a href="addMaps.html" class="btn btn-primary">
                                                    <i class="bi bi-map me-2"></i>Start Drawing
                                                </a>
                                            </div>
                                        </div>

                                        <div class="step d-flex align-items-start mb-4">
                                            <div class="step-icon me-3">
                                                <i class="bi bi-2-circle-fill fs-4 text-primary"></i>
                                            </div>
                                            <div>
                                                <h5>Connect with Runners</h5>
                                                <p>Follow other runners to see their routes and activities in your feed.</p>
                                                <a href="friends.html" class="btn btn-primary">
                                                    <i class="bi bi-people me-2"></i>Find Runners
                                                </a>
                                            </div>
                                        </div>

                                        <div class="step d-flex align-items-start">
                                            <div class="step-icon me-3">
                                                <i class="bi bi-3-circle-fill fs-4 text-primary"></i>
                                            </div>
                                            <div>
                                                <h5>Explore Routes</h5>
                                                <p>Discover popular running routes in your area and save them for later.</p>
                                                <a href="routes.html" class="btn btn-primary">
                                                    <i class="bi bi-compass me-2"></i>Browse Routes
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="activity-feed">
<div v-if="activities.length === 0 && !isLoading" class="text-center py-4">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <h5 class="mb-3">No Activities Yet</h5>
                                        <p class="text-muted">Follow other runners to see their activities here, or create your own route to share!</p>
                                        <div class="mt-3">
                                            <a href="addMaps.html" class="btn btn-primary me-2">
                                                <i class="bi bi-map me-2"></i>Create Route
                                            </a>
                                            <a href="friends.html" class="btn btn-outline-primary">
                                                <i class="bi bi-people me-2"></i>Find Runners
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <activity-card
                                v-else
                                v-for="activity in activities"
                                :key="activity.id"
                                :activity="activity"
                                :current-user="currentUser"
                                @like="likeActivity"
                                @share="handleActivityShare"  
                                @open-modal="openActivityModal">
                            </activity-card>
                        </div>
                    </div>

                    <!-- Updated modal component -->
                    <comment-modal
                        v-if="selectedActivity"
                        :activity="selectedActivity"
                        @close="selectedActivity = null"
                        @like="likeActivity"
                        @share="handleActivityShare" 
                    ></comment-modal>
                </div>
            </div>
        </div>

        <!-- Footer Section -->
        <site-footer></site-footer>
        </div>
    </div>
    

        <!-- Initial Vue app setup -->
    <script>

        const { createApp } = Vue

        // ActivityCard Component
        const ActivityCard = {
        props: {
            activity: {
                type: Object,
                required: true
            },
            currentUser: {  
                type: Object, // Change from String to Object
                required: true
            }
        },
        data() {
            return {
                disabledActions: {},
                lastApiCallTime: 0
            }
        },
        computed: {
            isLiked() {
                return this.activity.isLiked || false;
            },
            isOwnPost() {  
                return window.currentUser && this.activity.user === window.currentUser.username;
            },
            commentCount() {
                return this.activity.commentsList ? this.activity.commentsList.length : 0;
            }
        },
        methods: {
            handleEdit() {
                window.location.href = `addMaps.html?id=${this.activity.id}`;
            },
            useRoute() {
                window.location.href = `addMaps.html?id=${this.activity.id}`;
            },
            handleShare() {
                // Generate the share URL
                const shareUrl = `${window.location.origin}/homepage.html?id=${this.activity.id}`;
                
                // Copy the URL to the clipboard
                navigator.clipboard.writeText(shareUrl)
                    .then(() => {
                        // Emit the share event to parent component
                        this.$emit('share', this.activity);
                        
                        // Show success alert instead of using alert()
                        this.$root.setAlert('success', "Link copied to clipboard!");
                    })
                    .catch(err => {
                        console.error("Failed to copy link: ", err);
                        this.$root.setAlert('error', "Failed to copy link to clipboard");
                    });
            },
            async likePost() {
                this.$emit('like', this.activity);
            },
        },
        template: `
            <article class="post">
                <!-- Header -->
                <header>
                    <div class="title">
                        <div class="d-flex justify-content-between align-items-start">
                            <h2>{{ activity.title }}</h2>
                            <div v-if="isOwnPost" class="dropdown">
                                <button class="btn btn-link text-dark p-0" 
                                        type="button" 
                                        data-bs-toggle="dropdown" 
                                        aria-expanded="false"
                                        @click.stop>
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <button class="dropdown-item" @click.stop="handleEdit">
                                            <i class="fas fa-edit me-2"></i>Edit Post
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <p>by {{ activity.user }}</p>
                    </div>
                    <div class="meta">
                        <time class="published">{{ activity.date }}</time>
                        <div class="d-flex align-items-center justify-content-end mt-2">
                            <span class="me-2">{{ activity.user }}</span>
                            <img :src="activity.userImg" alt="Profile" class="rounded-circle" 
                                style="width: 40px; height: 40px; object-fit: cover;">
                        </div>
                    </div>
                </header>
                
                <!-- Main Image -->
                <div class="image featured" @click="$emit('open-modal', activity)">
                    <img :src="activity.mapImg" alt="Activity Map">
                </div>
                
                <!-- Content -->
                <div class="content">
                    <div class="d-flex justify-content-between text-center mb-3">
                        <div>
                            <h6 class="mb-0 fw-bold">{{ activity.distance }}</h6>
                            <small class="text-muted">Distance</small>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">{{ activity.time }}</h6>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <p v-if="activity.description" class="mb-0">{{ activity.description }}</p>
                        </div>
                        <div class="d-flex ms-3">
                            <div class="me-3">
                                <small class="text-muted">
                                    <i class="bi bi-geo-alt"></i> {{ activity.location }}
                                </small>
                            </div>
                            <div class="me-3">
                                <small class="text-muted">
                                    <i class="bi bi-heart"></i> {{ activity.likes || 0 }}
                                </small>
                            </div>
                            <div class="me-3">
                                <small class="text-muted">
                                    <i class="bi bi-chat"></i> {{ commentCount }}
                                </small>
                            </div>
                            <div>
                                <small class="text-muted">
                                    <i class="bi bi-share"></i> {{ activity.shares || 0 }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <footer>
                    <div class="actions">
                        <div class="d-flex justify-content-around border-top border-bottom py-3">
                            <button
                                class="btn btn-link p-0 action-button"
                                @click.stop="likePost()"
                                :class="{ 'liked': activity.isLiked }">
                                <i :class="[activity.isLiked ? 'fas' : 'far', 'fa-thumbs-up me-1']"></i>
                                <span>{{ activity.isLiked ? 'Liked' : 'Like' }}</span>
                            </button>
                            <button
                                class="btn btn-link p-0 action-button"
                                @click.stop="$emit('open-modal', activity)">
                                <i class="far fa-comment me-1"></i>
                                <span>Comment</span>
                            </button>
                            <button
                                class="btn btn-link p-0 action-button"
                                @click.stop="useRoute">
                                <i class="far fa-map me-1"></i>
                                <span>Use</span>
                            </button>
                            <button
                                class="btn btn-link p-0 action-button"
                                @click.stop="handleShare">
                                <i class="far fa-share-square me-1"></i>
                                <span>Share</span>
                            </button>
                        </div>
                    </div>
                </footer>
            </article>
        `
    }
        // CommentModal Component
        const CommentModal = {
            props: {
                activity: {
                    type: Object,
                    required: true
                }
            },

            data() {
                return {
                    newComment: '',
                    modal: null,
                    displayLimit: 4, 
                    showAllComments: false,
                    disabledActions: {},
                    lastApiCallTime: 0,
                    comments: [],
                    isLoading: false,
                    error: null,
                    API_ENDPOINT: 'https://app-907670644284.us-central1.run.app'
                }
            },

            computed: {
                isLiked() {
                    return this.activity.isLiked || false;
                },

                displayedComments() {
                    return this.comments.slice(0, this.displayLimit);
                },

                hasMoreComments() {
                    return this.comments.length > this.displayLimit;
                },

                remainingCommentsCount() {
                    const remaining = this.comments.length - this.displayLimit;
                    return Math.min(remaining, 4); // Show either remaining count or 4, whichever is smaller
                }
            },

            mounted() {
                // Initialize modal
                this.modal = new bootstrap.Modal(this.$el);
                this.modal.show();
                this.$el.addEventListener('hidden.bs.modal', () => {
                    this.$emit('close');
                });

                // Use the preloaded comments
                if (this.activity.commentsList && this.activity.commentsList.length > 0) {
                    this.comments = this.activity.commentsList
                        .map(comment => ({
                            ...comment,
                            timeAgo: this.calculateTimeSince(comment.createdAt)
                        }))
                        .sort((a, b) => {
                            const dateA = a.createdAt._seconds ? new Date(a.createdAt._seconds * 1000) : new Date(a.createdAt);
                            const dateB = b.createdAt._seconds ? new Date(b.createdAt._seconds * 1000) : new Date(b.createdAt);
                            return dateB - dateA;
                        });
                }
            },

            methods: {
                loadMoreComments() {
                    this.displayLimit += 4; // Increase limit by 4
                },

                async likePost(postId) {
                    // Emit the like event to parent instead of handling API call directly
                    this.$emit('like', this.activity);
                },

                calculateTimeSince(timestamp) {
                    if (!timestamp) return 'Just now';

                    let date;
                    if (timestamp._seconds) {
                        date = new Date(timestamp._seconds * 1000);
                    } else if (typeof timestamp === 'string' || timestamp instanceof Date) {
                        date = new Date(timestamp);
                    } else {
                        return 'Just now';
                    }

                    const now = new Date();
                    const diffInSeconds = Math.floor((now - date) / 1000);
                    const intervals = [
                        { label: 'year', seconds: 31536000 },
                        { label: 'month', seconds: 2592000 },
                        { label: 'day', seconds: 86400 },
                        { label: 'hour', seconds: 3600 },
                        { label: 'minute', seconds: 60 },
                        { label: 'second', seconds: 1 }
                    ];

                    for (const interval of intervals) {
                        const count = Math.floor(diffInSeconds / interval.seconds);
                        if (count >= 1) {
                            return count === 1 
                                ? `1 ${interval.label} ago` 
                                : `${count} ${interval.label}s ago`;
                        }
                    }
                    return 'Just now';
                },

                async submitComment() {
                    if (!this.newComment.trim()) return;

                    const currentTime = Date.now();
                    if (currentTime - this.lastApiCallTime < 1000) {
                        return; // Rate limiting to prevent rapid submissions
                    }
                    this.lastApiCallTime = currentTime;
                    this.disabledActions.comment = true;

                    try {
                        const response = await axios.post(
                            `${this.API_ENDPOINT}/api/posts/${this.activity.id}/comments`,
                            {
                                userID: window.currentUser.id,
                                text: this.newComment
                            }
                        );

                        // Add the new comment to the local list immediately
                        const newComment = {
                            id: response.data.id,
                            userID: window.currentUser.id,
                            text: this.newComment,
                            username: window.currentUser.username,
                            createdAt: response.data.createdAt || new Date(),
                            timeAgo: 'Just now'
                        };

                        // Update both local comments and activity comments
                        this.comments.unshift(newComment);
                        this.activity.commentsList.unshift(newComment);

                        this.newComment = ''; 

                    } catch (error) {
                        console.error('Error submitting comment:', error);
                        alert('Failed to submit comment. Please try again.');
                    } finally {
                        this.disabledActions.comment = false;
                    }
                },

                toggleShowAllComments() {
                    this.showAllComments = !this.showAllComments;
                },
                useRoute() {
                    window.location.href = `addMaps.html?id=${this.activity.id}`;
                },
                handleShare() {
                    // Update API and redirect
                    const shareUrl = `homepage.html?id=${this.activity.id}`;
                    this.$emit('share', this.activity); // Emit share event to parent
                    window.location.href = shareUrl;
                },
            },

            template: `
                <div class="modal fade" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <!-- Modal Header -->
                            <div class="modal-header d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="modal-title">{{ activity.title }}</h5>
                                    <h6 class="modal-author text-muted">by {{ activity.user }}</h6>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>

                            <!-- Modal Body -->
                            <div class="modal-body">
                                <div id="modal-pic">
                                    <img :src="activity.mapImg" alt="Activity Map" class="img-fluid">
                                </div>

                                <!-- Modal Content -->
                                <p class="text-muted">Posted {{ activity.date }}</p>
                                <p class="text-muted">
                                    {{ activity.likes || 0 }} Likes | 
                                    {{ comments.length }} Comments |
                                    {{ activity.shares || 0 }} Shares
                                </p>                                
                                <!-- Stats Row -->
                                <div class="d-flex mb-3">
                                    <p class="me-4"><strong>Distance:</strong> {{ activity.distance }}</p>
                                </div>
                                
                                <p>{{ activity.description }}</p>

                                <!-- Action Buttons -->
                                <div class="d-flex border-top border-bottom py-3">
                                    <div class="d-flex w-100 px-4" style="justify-content: space-between; padding-left: 20% !important; padding-right: 20% !important;">
                                        <button class="btn btn-link p-0 action-button" 
                                                @click="likePost(activity.id)"
                                                :class="{ 'liked': isLiked }"
                                                :disabled="disabledActions.like">
                                            <i :class="[activity.isLiked ? 'fas' : 'far', 'fa-thumbs-up me-1']"></i>
                                            <span>{{ activity.isLiked ? 'Liked' : 'Like' }}</span>
                                        </button>

                                        <button class="btn btn-link p-0 action-button"
                                                @click="useRoute"
                                                :disabled="disabledActions.use">
                                            <i class="far fa-map me-1"></i>
                                            <span>Use</span>
                                        </button>

                                        <button class="btn btn-link p-0 action-button"
                                                @click="handleShare"
                                                :disabled="disabledActions.share">
                                            <i class="far fa-share-square me-1"></i>
                                            <span>Share</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Comments Section -->
                                <div class="mt-4">                                    
                                    <!-- New Comment Input -->
                                    <div class="mb-3">
                                        <textarea class="form-control mb-2"
                                                placeholder="Add a comment..."
                                                rows="2"
                                                v-model="newComment"
                                                :disabled="disabledActions.comment"></textarea>
                                        <button class="btn btn-primary"
                                                @click="submitComment"
                                                :disabled="disabledActions.comment">
                                            <span v-if="!disabledActions.comment">Post Comment</span>
                                            <span v-else>
                                                <i class="fas fa-spinner fa-spin"></i> Posting...
                                            </span>
                                        </button>
                                    </div>

                                    <h6>Comments ({{ comments.length }})</h6>

                                    
                                    <!-- Display comments if they exist -->
                                    <div v-if="comments && comments.length > 0">
                                        <div v-for="comment in displayedComments" :key="comment.id" class="mb-3">
                                            <div class="comment-bubble">
                                                <strong>{{ comment.username }}</strong>
                                                <p>{{ comment.text }}</p>
                                            </div>
                                            <div class="comment-time text-muted">
                                                {{ calculateTimeSince(comment.createdAt) }}
                                            </div>
                                        </div>
                                        <!-- Show More Comments Button -->
                                        <div v-if="hasMoreComments" class="text-center mt-3 mb-3">
                                            <button 
                                                @click="loadMoreComments" 
                                                class="btn btn-outline-primary btn-sm">
                                                Show {{ remainingCommentsCount }} more comments
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Display prompt if no comments -->
                                    <div v-else>
                                        <p>No comments yet. Be the first to comment!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `
        }

        // vue app with axios data fetching
        const app = createApp({
            components: {
                ActivityCard,
                CommentModal, 
            },
            data() {
                return {
                    API_ENDPOINT: 'https://app-907670644284.us-central1.run.app',
                    currentUser: '',
                    selectedActivity: null,
                    lastApiCallTime: 0,
                    userProfile: {
                        name: '',
                        username: '',
                        avatar: '',
                        stats: {
                            routes: 0,
                            following: 0,
                            followers: 0
                        }
                    },
                    heroStats: [
                        { 
                            id: 1, 
                            icon: 'bi bi-people-fill', 
                            text: '2.5k Active Runners' 
                        },
                        { 
                            id: 2, 
                            icon: 'bi bi-map-fill', 
                            text: '500+ Shared Routes' 
                        },
                        { 
                            id: 3, 
                            icon: 'bi bi-trophy-fill', 
                            text: 'Daily Achievements' 
                        }
                    ],
                    menuItems: [
                        { 
                            id: 1, 
                            icon: 'bi bi-activity', 
                            text: 'My Activities', 
                            route: 'profile_page.html' 
                        },
                        { 
                            id: 2, 
                            icon: 'bi bi-trophy', 
                            text: 'Leaderboard', 
                            route: 'leaderboard.html' 
                        }
                    ],
                    trendingRoutes: [],
                    activities: [],
                    postID: null, //share url param
                    error: null, // For handling errors in loading comments
                    showAlert: false,
                    alertTimeout: null,
                    hidden: true,
                    alertType: '',
                    alertMessage: '',
                    suggestedUsers: [],
                    isLoading: false,
                }
            },
            created() {
                const loadingSpinner = document.getElementById('loading-spinner');
                const appContainer = document.getElementById('app-container');

                const urlParams = new URLSearchParams(window.location.search);
                this.postId = urlParams.get('id');

                const initializeApp = async () => {
                    try {
                        // Load suggested users first
                        await this.loadSuggestedUsers();
                        
                        // Then try to fetch posts
                        if (this.postId) {
                            await this.fetchSinglePost(this.postId);
                        } else {
                            await this.fetchPosts();
                        }
                    } catch (error) {
                        console.error('Error during initialization:', error);
                        // Still continue to show the app even if there's an error
                    } finally {
                        if (loadingSpinner && appContainer) {
                            loadingSpinner.style.display = 'none';
                            appContainer.style.display = 'block';
                        }
                    }
                };

                // Check for window.currentUser
                const checkUser = setInterval(() => {
                    if (window.currentUser) {
                        clearInterval(checkUser);
                        console.log('User data found:', window.currentUser);
                        
                        this.currentUser = window.currentUser;
                        this.currentUserId = window.currentUser.id;
                        this.updateUserProfile(window.currentUser);
                        
                        initializeApp();
                    }
                }, 100);
            },

            computed: {
                isNewUser() {
                    return (!this.activities || this.activities.length === 0) || 
                        (!this.userProfile.stats.following || this.userProfile.stats.following === 0);
                }
            },

            methods: {
                async loadSuggestedUsers() {
                    if (!this.currentUser || !this.currentUser.id) {
                        console.log('Current user not available yet');
                        return;
                    }
                    
                    try {
                        const response = await axios.get(`${this.API_ENDPOINT}/api/users/getcondensed/${this.currentUser.id}`);
                        
                        if (response.data && Array.isArray(response.data)) {
                            // Filter out current user and already followed users
                            let eligibleUsers = response.data.filter(user => 
                                user.userID !== this.currentUser.id && !user.isFollowing
                            );
                            
                            // Shuffle the array 
                            for (let i = eligibleUsers.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [eligibleUsers[i], eligibleUsers[j]] = [eligibleUsers[j], eligibleUsers[i]];
                            }
                            
                            // Take first 5 users from shuffled array
                            this.suggestedUsers = eligibleUsers.slice(0, 5);
                            
                            console.log('Loaded randomized suggested users:', this.suggestedUsers);
                        } else {
                            console.log('No suggested users found');
                            this.suggestedUsers = [];
                        }
                    } catch (error) {
                        console.error('Error loading suggested users:', error);
                        this.suggestedUsers = [];
                    }
                },
                
                async followUser(user) {
                    try {
                        // Make API call to follow user
                        await axios.post(`${this.API_ENDPOINT}/api/follow?id=${user.userID}`, {
                            userID: this.currentUser.id
                        });
                        
                        // Update UI
                        user.isFollowing = true;
                        
                        // Update suggested users list
                        this.suggestedUsers = this.suggestedUsers.filter(u => u.userID !== user.userID);
                        
                        // Refresh activities
                        await this.fetchPosts();
                    } catch (error) {
                        console.error('Error following user:', error);
                    }
                },

                dismissAlert() {
                    this.showAlert = false;
                    setTimeout(() => {
                        this.hidden = true;
                        this.alertMessage = '';
                    }, 300);
                    if (this.alertTimeout) {
                        clearTimeout(this.alertTimeout);
                        this.alertTimeout = null;
                    }
                },

                setAlert(type, message) {
                    if (this.alertTimeout) {
                        clearTimeout(this.alertTimeout);
                        this.alertTimeout = null;
                    }

                    this.hidden = false;
                    this.alertType = type;
                    this.alertMessage = message;

                    setTimeout(() => {
                        this.showAlert = true;
                    }, 10);

                    this.alertTimeout = setTimeout(() => {
                        this.dismissAlert();
                        this.alertTimeout = null;
                    }, 3000);
                },
                async fetchSinglePost(postId) {
                    this.isLoading = true;
                    try {
                        // Fetch the specific shared post
                        const response = await axios.get(`${this.API_ENDPOINT}/api/posts/?id=${postId}`);
                        const post = response.data;
                        
                        if (!post) {
                            console.error('No post data received');
                            this.activities = [];
                            return;
                        }

                        // Initialize the activity with post data
                        const activity = {
                            id: post.postID,
                            title: post.title,
                            user: post.username || 'Unknown User',
                            userImg: post.profilePicture || this.userProfile.avatar,
                            date: this.calculateTimeSince(post.createdAt),
                            location: post.waypoints[0].address,
                            description: post.description,
                            distance: `${post.distance} km`,
                            time: post.time || '',
                            mapImg: post.image,
                            likes: post.likeCount,
                            shares: post.shareCount,
                            commentsList: [], // Initialize empty comments list
                            isLiked: this.currentUser.postsLiked?.includes(post.postID) || false
                        };

                         // Fetch comments and their user data
                        try {
                            const commentsResponse = await axios.get(
                                `${this.API_ENDPOINT}/api/posts/${post.postID}/comments`
                            );
                            const comments = commentsResponse.data;

                            // Get unique user IDs from comments
                            const commentUserIDs = [...new Set(comments.map(comment => comment.userID))];

                            // Fetch user data for comment authors
                            const commentUserPromises = commentUserIDs.map(userId =>
                                axios.get(`${this.API_ENDPOINT}/api/${userId}`)
                                    .then(response => ({
                                        id: userId,
                                        username: response.data.username
                                    }))
                                    .catch(() => ({
                                        id: userId,
                                        username: 'Unknown User'
                                    }))
                            );

                            const commentUsers = await Promise.all(commentUserPromises);
                            const commentUserMap = {};
                            commentUsers.forEach(user => {
                                commentUserMap[user.id] = user.username;
                            });

                            // Add usernames to comments
                            activity.commentsList = comments.map(comment => ({
                                ...comment,
                                username: commentUserMap[comment.userID] || 'Unknown User'
                            }));
                        } catch (error) {
                            if (error.response?.status !== 404) {
                                console.error(`Error fetching comments:`, error);
                            }
                            activity.commentsList = [];
                        }

                        // Update share count
                        try {
                            await axios.put(`${this.API_ENDPOINT}/api/posts/share?id=${postId}`);
                        } catch (error) {
                            console.error('Error updating share count:', error);
                        }

                        // Set as only activity
                        this.activities = [activity];

                        // Fetch trending routes
                        const allPostsResponse = await axios.get(`${this.API_ENDPOINT}/api/allposts/user/${this.currentUser.id}`);
                        const allPosts = allPostsResponse.data;

                        this.trendingRoutes = allPosts
                            .sort((a, b) => {
                                const likesDiff = (b.likeCount || 0) - (a.likeCount || 0);
                                return likesDiff !== 0 ? likesDiff : (b.shareCount || 0) - (a.shareCount || 0);
                            })
                            .slice(0, 2)
                            .map(post => ({
                                id: post.postID,
                                title: post.title,
                                distance: `${post.distance} km`,
                                saves: `${post.likeCount || 0} likes`,
                                image: post.image
                            }));

                    } catch (error) {
                        console.error('Error fetching single post:', error);
                        this.activities = [];
                        this.trendingRoutes = [];
                    } finally {
                        this.isLoading = false;
                    }
                },

                async handleActivityShare(activity) {
                    // Define the request URL and the payload with userID
                    const requestUrl = `${this.API_ENDPOINT}/api/posts/share?id=${activity.id}`;
                    const payload = {
                        userID: this.currentUser.id // Assuming `this.currentUser.id` contains the user ID
                    };

                    // Send the PUT request with the userID payload
                    const response = await axios.put(requestUrl, payload);

                    // Increment the share count on the frontend if the request succeeds
                    activity.shares = (activity.shares || 0) + 1;
                    // console.log("Share count successfully updated in Firestore:", response.data);
                },

                calculateTimeSince(dateObj) {
                    if (!dateObj) return 'Just Now';

                    let date;
                    if (dateObj._seconds) {
                        date = new Date(dateObj._seconds * 1000);
                    } else {
                        date = new Date(dateObj);
                    }

                    const currentDate = new Date();
                    const diffInSeconds = Math.floor((currentDate - date) / 1000);
                    const intervals = [
                        { label: 'year', seconds: 31536000 },
                        { label: 'month', seconds: 2592000 },
                        { label: 'day', seconds: 86400 },
                        { label: 'hour', seconds: 3600 },
                        { label: 'minute', seconds: 60 },
                        { label: 'second', seconds: 1 }
                    ];

                    for (const interval of intervals) {
                        const count = Math.floor(diffInSeconds / interval.seconds);
                        if (count >= 1) {
                            return count === 1
                                ? `1 ${interval.label} ago`
                                : `${count} ${interval.label}s ago`;
                        }
                    }
                    return 'Just Now';
                },
                updateUserProfile(userData) {
                    this.userProfile = {
                        name: userData.username,
                        username: `@${userData.username}`,
                        avatar: userData.profilePicture || 'resources/download.jpeg',
                        stats: {
                            routes: userData.postsCreated?.length || 0,
                            following: userData.following?.length || 0,  
                            followers: userData.followers?.length || 0   
                        }
                    };
                },

                async fetchPosts() {
                    this.isLoading = true;
                    try {
                        const currentUserId = window.currentUser.id;
                        console.log('Current user ID:', currentUserId);

                        console.log('Fetching posts for current user...');
                        const response = await axios.get(`${this.API_ENDPOINT}/api/allposts/user/${currentUserId}`);
                        const allPosts = response.data;
                        console.log(`Total posts fetched: ${allPosts.length}`);

                        if (allPosts && allPosts.length > 0) {
                        // Map posts with initial data
                            this.activities = allPosts.map(post => ({
                                ...post,
                                id: post.postID,
                                user: post.username || 'Unknown User',
                                userImg: post.profilePicture || this.userProfile.avatar,
                                date: this.calculateTimeSince(post.createdAt),
                                location: post.waypoints[0].address,
                                title: post.title,
                                routeTitle: post.title,
                                description: post.description,
                                distance: `${post.distance} km`,
                                mapImg: post.image,
                                likes: post.likeCount,
                                commentsList: [], // Initialize empty comments list
                                shares: post.shareCount,
                                isLiked: post.likedBy.includes(currentUserId)
                            }));

                            // Extract unique user IDs from posts
                            const userIDs = [...new Set(this.activities.map(post => post.userID))];

                            // Fetch user data for each unique userID (post creators)
                            const userPromises = userIDs.map(id =>
                                axios.get(`${this.API_ENDPOINT}/api/${id}`)
                                    .then(userResponse => ({
                                        id,
                                        username: userResponse.data.username
                                    }))
                                    .catch(error => {
                                        console.error(`Error fetching user data for ${id}:`, error);
                                        return { id, username: 'Unknown User' };
                                    })
                            );

                            // Wait for all user data to be fetched
                            const users = await Promise.all(userPromises);

                            // Create a userMap for quick lookup
                            const userMap = {};
                            users.forEach(user => {
                                userMap[user.id] = user.username;
                            });

                            // Update usernames in activities
                            this.activities.forEach(activity => {
                                activity.user = userMap[activity.userID] || 'Unknown User';
                            });

                            const commentPromises = this.activities.map(async activity => {
                                try {
                                    const commentsResponse = await axios.get(`${this.API_ENDPOINT}/api/posts/${activity.id}/comments`);
                                    const comments = commentsResponse.data;

                                    // Get unique user IDs from comments
                                    const commentUserIDs = [...new Set(comments.map(comment => comment.userID))];

                                    // Fetch user data for comment authors
                                    const commentUserPromises = commentUserIDs.map(userId =>
                                        axios.get(`${this.API_ENDPOINT}/api/${userId}`)
                                            .then(response => ({
                                                id: userId,
                                                username: response.data.username
                                            }))
                                            .catch(() => ({
                                                id: userId,
                                                username: 'Unknown User'
                                            }))
                                    );

                                    const commentUsers = await Promise.all(commentUserPromises);
                                    const commentUserMap = {};
                                    commentUsers.forEach(user => {
                                        commentUserMap[user.id] = user.username;
                                    });

                                    // Add usernames to comments
                                    activity.commentsList = comments.map(comment => ({
                                        ...comment,
                                        username: commentUserMap[comment.userID] || 'Unknown User'
                                    }));
                                } catch (error) {
                                    if (error.response?.status === 404) {
                                        activity.commentsList = [];
                                    } else {
                                        console.error(`Error fetching comments for post ${activity.id}:`, error);
                                    }
                                }
                            });

                            // Wait for all comments to be fetched
                            await Promise.all(commentPromises);

                            // Sort activities by date
                            this.activities.sort((a, b) => {
                                const dateA = a.createdAt._seconds ? new Date(a.createdAt._seconds * 1000) : new Date(a.createdAt);
                                const dateB = b.createdAt._seconds ? new Date(b.createdAt._seconds * 1000) : new Date(b.createdAt);
                                return dateB - dateA;
                            });

                            // Set trending routes
                            this.trendingRoutes = allPosts
                                .sort((a, b) => {
                                    const likesDiff = (b.likeCount || 0) - (a.likeCount || 0);
                                    return likesDiff !== 0 ? likesDiff : (b.shareCount || 0) - (a.shareCount || 0);
                                })
                                .slice(0, 2)
                                .map(post => ({
                                    id: post.postID,
                                    title: post.title,
                                    distance: `${post.distance} km`,
                                    saves: `${post.likeCount || 0} likes`,
                                    image: post.image
                                }));
                        } else {
                            this.activities = [];
                            this.trendingRoutes = [];
                        }

                    } catch (error) {
                        // Handle 404
                        if (error.response && error.response.status === 404) {
                            console.log('No posts found for user - new user detected');
                            this.activities = [];
                            this.trendingRoutes = [];
                        } else {
                            console.error('Error in fetchPosts:', error);
                        }
                    } finally {
                        this.isLoading = false;
                    }
                },

                formatDate(dateObj) {
                    const date = dateObj._seconds ? 
                        new Date(dateObj._seconds * 1000) : 
                        new Date(dateObj);
                        
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }).replace('at', 'at');
                },

                openActivityModal(activity) {
                    this.selectedActivity = activity;
                },
                
                async likeActivity(activity) {
                    // Rate limit to prevent rapid toggling
                    const currentTime = Date.now();
                    if (currentTime - this.lastApiCallTime < 1000) {
                        return;
                    }
                    this.lastApiCallTime = currentTime;

                    // Determine API endpoint based on current `isLiked` status
                    const endpoint = `${this.API_ENDPOINT}/api/posts/${activity.isLiked ? 'unlike' : 'like'}?id=${activity.id}`;
                    const payload = { userID: this.currentUserId };

                    try {
                        // Make the request to like or unlike
                        const response = await axios.put(endpoint, payload);

                        if (response.status === 200) {
                            // Toggle the like status
                            activity.isLiked = !activity.isLiked;
                            activity.likes += activity.isLiked ? 1 : -1;

                            // Ensure postsLiked is defined as an array
                            if (!Array.isArray(this.currentUser.postsLiked)) {
                                this.currentUser.postsLiked = [];
                            }

                            // Update the `postsLiked` array for the current user
                            if (activity.isLiked) {
                                // Add activity ID if not already present
                                if (!this.currentUser.postsLiked.includes(activity.id)) {
                                    this.currentUser.postsLiked.push(activity.id);
                                }
                            } else {
                                // Remove activity ID if it exists
                                const index = this.currentUser.postsLiked.indexOf(activity.id);
                                if (index > -1) {
                                    this.currentUser.postsLiked.splice(index, 1);
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error toggling like:', error);

                        // Optional error handling: display an alert or revert the like status
                        alert('Failed to update like. Please try again.');
                    }
                },

                viewRoute(route) {
                    // Find the activity in `activities` that matches the route ID
                    const matchedActivity = this.activities.find(activity => activity.id === route.id);

                    if (matchedActivity) {
                        // Open the activity modal with the matched activity data
                        this.openActivityModal(matchedActivity);
                    } else {
                        // Optional: fallback if no match found
                        console.warn(`No matching activity found for route ID: ${route.id}`);
                        alert('Activity details are currently unavailable.');
                    }
                },
            }
        });
    </script>

    <!-- import navbar from navbar.js -->
    <script src="navbar/navbar.js"></script>

    <!-- import footer from footer.js -->
    <script src="footer/footer.js"></script>

    <script>
        app.mount('#app')
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>