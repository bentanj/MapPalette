<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapPalette - Leaderboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="routes.css">
    <link rel="stylesheet" href="navbar/navbar_style.css">
    <link rel="stylesheet" href="footer/footer_style.css">
    <link rel="stylesheet" href="loading-quotes/loading_quotes_style.css">
    <script type="module" src="firebase.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>    
    <style>
        body {
            background-color: #f5f5f5;
            color: #333333;
            min-height: 100vh;
        }

        .content-wrapper {
            padding-top: 80px;
        }

        .page-title {
            color: #333;
            margin-bottom: 2rem;
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
        }

        .leaderboard-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .player-card {
            background-color: #ffffff;
            border-radius: 8px;
            margin-bottom: 1rem;
            padding: 1rem;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .player-card:hover {
            transform: translateX(5px);
            background-color: #f8f9fa;
        }

        .current-user-card {
            background-color: #ffe6e6;
            border: 2px solid #FF6B6B !important;
        }

        .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }

        .stats-container {
            display: flex;
            gap: 2rem;
            color: #666666;
        }

        .rank-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .rank-champion { background-color: #01d8dc; color: white; }
        .rank-master { background-color: #c33c3c; color: white; }
        .rank-pro { background-color: #9c3cc3; color: white; }
        .rank-elite { background-color: #544ac3; color: white; }
        .rank-newbie { background-color: #6c3702; color: white; }

        .trophy-icon {
            color: #ffd700;
            margin-right: 0.5rem;
        }

        .silver-trophy { color: #c0c0c0; }
        .bronze-trophy { color: #cd7f32; }

        .table-header {
            color: #333;
            font-size: 0.95rem;
            font-weight: bold;
            padding: 0.75rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .no-points {
            color: #999;
            font-style: italic;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .bounce {
            animation: bounce 0.8s;
        }

        .player-card:hover.bounce {
            cursor: pointer;
        }

        .points-container {
            position: relative;
            padding: 0 20px;
        }
        
        .points-circle {
            background-color: rgba(248, 249, 250, 0.7);
            border-radius: 12px;
            padding: 12px 24px;
            display: inline-block;
            min-width: 120px;
            backdrop-filter: blur(4px);
        }
        
        .current-user-card .points-circle {
            background-color: rgba(255, 230, 230, 0.7);
        }

        @media (max-width: 576px) {
            .table-header {
                font-size: 0.85rem;
                padding: 0.5rem;
            }

            .player-card {
                padding: 0.75rem;
            }

            .profile-pic {
                width: 40px;
                height: 40px;
            }

            .rank-badge {
                min-width: 70px;
                font-size: 0.75rem;
                padding: 0.2rem 0.5rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .fs-5 {
                font-size: 1.1rem !important;
            }
            
            .points-circle {
                min-width: 100px;
                padding: 8px 16px;
            }
            
            .fs-4 {
                font-size: 1.2rem !important;
            }
            
            .trophy-icon {
                font-size: 40px !important;
                margin-right: 10px !important;
                margin-top: 10px !important;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <loading-quotes v-if="isLoading"></loading-quotes>

        <div v-show="!isLoading">

            <nav-bar :user_profile="currentUser"></nav-bar>

            <div class="content-wrapper">
                <div class="leaderboard-container">
                    <h1 class="page-title">Leaderboard</h1>
                    
                    <!-- Top Players Section -->
                    <div class="row mb-5">
                        <template v-for="(user, index) in topPlayers" :key="user.userID">
                            <div class="col-md-4">
                                <div 
                                    class="player-card"
                                    :class="{ 'current-user-card bounce': isCurrentUser(user.userID) }"
                                    @mouseenter="triggerConfetti(user.userID, index)">
                                    <div class="d-flex align-items-center">
                                        <img :src="user.profilePicture" :alt="user.username" class="profile-pic me-3">
                                        <div>
                                            <h5 class="mb-1">{{ user.username }}</h5>
                                            <span :class="'rank-badge rank-' + getRank(index)">{{ getRankDisplay(index) }}</span>
                                        </div>
                                        <div class="ms-auto">
                                            <i class="fas fa-trophy trophy-icon" 
                                            :class="{'silver-trophy': index === 1, 'bronze-trophy': index === 2}"
                                            style="font-size:55px; margin-right: 20px; margin-top: 20px;"></i>
                                        </div>
                                    </div>
                                    <div class="text-center mt-4 points-container">
                                        <div class="points-circle">
                                            <div class="fw-bold text-muted mb-1">Points</div>
                                            <div class="fs-4">{{ formatPoints(user.points) }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Leaderboard Table -->
                    <div class="table-header">
                        <div class="row align-items-center">
                            <div class="col-1 col-sm-2">#</div>
                            <div class="col-1 col-sm-1"></div><!-- Space for profile photo -->
                            <div class="col-4 col-sm-3">Player Name</div>
                            <div class="col-3">Points</div>
                            <div class="col-3">Rank</div>
                        </div>
                    </div>

                    <template v-for="(user, index) in remainingUsers" :key="user.userID">
                        <div class="player-card" 
                            :class="{ 'current-user-card': isCurrentUser(user.userID) }">
                            <div class="row align-items-center">
                                <div class="col-1 col-sm-2">{{ getSortedPosition(index) }}</div>
                                <div class="col-1 col-sm-1">
                                    <img :src="user.profilePicture" 
                                        :alt="user.username" 
                                        class="profile-pic" 
                                        @click="goToProfile(user.userID)">
                                </div>
                                <div class="col-4 col-sm-3">
                                    <span class="d-none d-sm-inline">{{ user.username }}</span>
                                    <span class="d-sm-none text-truncate">{{ user.username }}</span>
                                </div>
                                <div class="col-3" :class="{ 'no-points': !hasPoints(user) }">
                                    {{ formatPoints(user.points) }}
                                </div>
                                <div class="col-3">
                                    <span :class="'rank-badge rank-' + getRank(getSortedPosition(index) - 1)">
                                        {{ getRankDisplay(getSortedPosition(index) - 1) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
        <button @click="scrollToTop" class="btn back-to-top">
            <i class="fas fa-chevron-up"></i>
        </button>

        <site-footer></site-footer>
    </div>

    <script>
        const app = Vue.createApp({
            data() {
                return {
                    users: [],
                    baseURL: 'https://app-907670644284.us-central1.run.app',
                    isLoading: true,
                    currentUser: {
                        id: '',
                        username: '',
                        avatar: 'resources/default-profile-picture.jpg',
                        profilePicture: 'resources/default-profile-picture.jpg'
                    }
                }
            },
            computed: {
                sortedUsers() {
                    return [...this.users].sort((a, b) => {
                        const pointsA = a.points ?? 0;
                        const pointsB = b.points ?? 0;
                        
                        if (pointsB !== pointsA) {
                            return pointsB - pointsA;
                        }
                        
                        return a.username.localeCompare(b.username);
                    });
                },
                topPlayers() {
                    return this.sortedUsers
                        .filter(user => this.hasPoints(user))
                        .slice(0, 3);
                },
                remainingUsers() {
                    const withPoints = this.sortedUsers
                        .filter(user => this.hasPoints(user))
                        .slice(3);
                    
                    const withoutPoints = this.sortedUsers
                        .filter(user => !this.hasPoints(user))
                        .sort((a, b) => a.username.localeCompare(b.username));
                    
                    return [...withPoints, ...withoutPoints];
                }
            },
            methods: {
                hasPoints(user) {
                    return user.points != null && user.points > 0;
                },
                formatPoints(points) {
                    return this.hasPoints({ points }) ? points : 'No points yet';
                },
                getSortedPosition(index) {
                    const position = index + 4;
                    return !this.hasPoints(this.remainingUsers[index]) ? '-' : position;
                },
                getRank(index) {
                    if (index === 0) return 'champion';
                    if (index === 1) return 'master';
                    if (index === 2) return 'pro';
                    if (index >= 3 && index < 10) return 'elite';
                    return 'newbie';
                },
                getRankDisplay(index) {
                    if (index === 0) return 'Champion';
                    if (index === 1) return 'Master';
                    if (index === 2) return 'Pro';
                    if (index >= 3 && index < 10) return 'Elite';
                    return 'Newbie';
                },
                goToProfile(userId) {
                    window.location.href = `./profile_page.html?id=${userId}`;
                },
                scrollToTop() {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                },
                isCurrentUser(userId) {
                    return window.currentUser && window.currentUser.id === userId;
                },
                triggerConfetti(userId, index) {
                    if (this.isCurrentUser(userId) && index < 3) {
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                    }
                },
                async fetchLeaderboardData() {
                    try {
                        const response = await axios.get(`${this.baseURL}/api/challenge/leaderboard`);
                        this.users = response.data;
                    } catch (error) {
                        console.error('Error fetching leaderboard data:', error);
                    }
                }
            },
            async mounted() {
                const initUser = (user) => {
                    this.currentUser = {
                        ...user,
                        avatar: user.profilePicture || 'resources/default-profile-picture.jpg',
                        profilePicture: user.profilePicture || 'resources/default-profile-picture.jpg'
                    };
                };

                window.addEventListener('userLoaded', async () => {
                    if (window.currentUser) {
                        initUser(window.currentUser);
                        await this.fetchLeaderboardData();
                        this.isLoading = false;
                    }
                });

                if (window.currentUser) {
                    initUser(window.currentUser);
                    await this.fetchLeaderboardData();
                    this.isLoading = false;
                }
            }
        });
    </script>

    <script src="navbar/navbar.js"></script>
    <script src="footer/footer.js"></script>
    <script src="loading-quotes/loading_quotes.js"></script>

    <script>
        app.mount('#app')
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>