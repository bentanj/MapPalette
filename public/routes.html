<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta and Title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapPalette - Feed</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Updated CSS Styles -->
    <link rel="stylesheet" href="search.css">

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Axios for HTTP Requests -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body>
    <div id="app">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg stroke">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><img src="route_photos/mappalettelogo.png">MapPalette</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon text-white"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item">
                            <a class="nav-link" href="#">Feed</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button"
                                id="searchDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                Search
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="searchDropdown">
                                <li><a class="dropdown-item" href="routes.html">Routes</a></li>
                                <li><a class="dropdown-item" href="friends.html">Friends</a></li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Draw</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button"
                                id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <img src="route_photos/download.jpeg" alt="Profile" class="profile-pic">
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                                <li><a class="dropdown-item" href="#">Your Profile</a></li>
                                <li><a class="dropdown-item" href="#">Settings</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="#">Log Out</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>


        <!-- Feed Header -->
        <div class="sample-header">
            <div class="sample-header-section">
                <h1>Routes</h1>
                <h2>Discover, share, and engage with creative running routes.</h2>
            </div>
        </div>

        <!-- Main Content Wrapper -->
        <div class="sample-section-wrap">
            <div class="container-fluid sample-section">
                <!-- Your main content (Vue components) -->
                <div>
                    <!-- Filter button and dropdown -->
                    <div class="d-flex align-items-center mb-2 flex-wrap">
                        <!-- Group badge and button, and push them to the right -->
                        <div class="d-flex align-items-center ms-auto">
                            <!-- Badge -->
                            <span v-if="filters.sortOption" class="badge me-2">
                                {{ filters.sortOption }}
                                <span @click="removeFilter()" class="ms-1">&times;</span>
                            </span>

                            <!-- Filter Options Button -->
                            <div class="dropdown">
                                <button class="btn filter-btn dropdown-toggle" type="button" id="filterDropdown"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    Sort By
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="filterDropdown">
                                    <!-- Sort by Distance -->
                                    <li>
                                        <h6 class="dropdown-header">Distance</h6>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Shortest')">Shortest to
                                            Longest</a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Longest')">Longest to
                                            Shortest</a>
                                    </li>

                                    <!-- Sort by Popularity -->
                                    <li>
                                        <h6 class="dropdown-header">Popularity</h6>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Most Popular')">Most
                                            Popular</a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Least Popular')">Least
                                            Popular</a>
                                    </li>

                                    <!-- Sort by Time Created -->
                                    <li>
                                        <h6 class="dropdown-header">Time Created</h6>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Newest')">Newest</a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Oldest')">Oldest</a>
                                    </li>

                                    <!-- Reset Button -->
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" @click="resetFilters()">Reset
                                            Filters</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Cards -->
                    <div class="row mt-4">
                        <route-cards :routes="filteredRoutes"></route-cards>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <route-modals :routes="filteredRoutes" @post-comment="postComment"></route-modals>

        <button @click="scrollToTop" class="btn back-to-top">
            <i class="fas fa-chevron-up"></i>
        </button>
    </div>



    <!-- Footer -->
    <footer class="text-center mt-5">
        <div class="container p-5">
            <!-- Grid row -->
            <div class="row align-items-center">
                <div class="col-lg-4 col-md-6 mb-4 mb-md-0">
                    <h5 class="text-uppercase fw-bold">MapPalette</h5>
                </div>

                <div class="col-lg-4 col-md-6 mb-4 mb-md-0">
                    <h6 class="fw-bold">Contact us</h6>
                    <p class="mb-1">mappalette@gmail.com</p>
                    <p class="mb-1">+65-687654321</p>
                    <p>81 Victoria St, Singapore 188065</p>
                </div>

                <div class="col-lg-4 col-md-12 text-md-end">
                    <a href="#" class="me-3 text-white"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="me-3 text-white"><i class="fab fa-linkedin-in"></i></a>
                    <a href="#" class="me-3 text-white"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="text-white"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <hr class="my-4">
            <div class="text-center">
                <p class="mb-0">&copy; 2024. All rights reserved.</p>
            </div>
        </div>
    </footer>

    </div>
</body>


<script>
    const app = Vue.createApp({
        data() {
            return {
                isDropdownOpen: false,
                filters: {
                    sortOption: null
                },
                routes: [],
                filteredRoutes: [],
                userName: 'You' // have to replace this with whatever the CURRENT username is
            };
        },
        created() {
            this.getRoutesData();
        },
        computed: {
            activeFilters() {
                return this.filters.sortOption ? [{ key: 'Sort By', value: this.filters.sortOption }] : [];
            }
        },
        methods: {
            getRoutesData() {
                axios
                    .get('data.json')
                    .then((response) => {
                        // Precompute the time since for each route
                        this.routes = response.data.routes.map((route) => ({
                            ...route,
                            timeSince: this.calculateTimeSince(route.date),
                        }));
                        this.filteredRoutes = [...this.routes];
                    })
                    .catch((error) => {
                        console.error('There was an error fetching the routes:', error);
                    });
            },
            calculateTimeSince(dateString) {
                const postDate = new Date(dateString);
                const currentDate = new Date();
                const diffInSeconds = Math.floor((currentDate - postDate) / 1000);

                const intervals = [
                    { label: 'year', seconds: 31536000 },
                    { label: 'month', seconds: 2592000 },
                    { label: 'day', seconds: 86400 },
                    { label: 'hour', seconds: 3600 },
                    { label: 'minute', seconds: 60 },
                    { label: 'second', seconds: 1 },
                ];

                for (const interval of intervals) {
                    const count = Math.floor(diffInSeconds / interval.seconds);
                    if (count >= 1) {
                        return count === 1
                            ? `1 ${interval.label} ago`
                            : `${count} ${interval.label}s ago`;
                    }
                }
                return 'Just Now';
            },
            postComment(route, commentText) {
                const newComment = {
                    name: this.userName,
                    text: commentText
                };

                // Directly update the route's commentsList
                route.commentsList.push(newComment);
            },
            formatFilterLabel(key) {
                // Capitalize the first letter and replace underscores with spaces if any
                return key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
            },
            setFilter(value) {
                this.filters.sortOption = value;
                this.applyFilters();
            },
            removeFilter() {
                this.filters.sortOption = null;
                this.applyFilters();
            },
            applyFilters() {
                let routes = [...this.routes];

                if (this.filters.sortOption) {
                    switch (this.filters.sortOption) {
                        case 'Shortest':
                            routes.sort((a, b) => parseInt(a.distance) - parseInt(b.distance));
                            break;
                        case 'Longest':
                            routes.sort((a, b) => parseInt(b.distance) - parseInt(a.distance));
                            break;
                        case 'Most Popular':
                            routes.sort((a, b) => b.likes - a.likes);
                            break;
                        case 'Least Popular':
                            routes.sort((a, b) => a.likes - b.likes);
                            break;
                        case 'Newest':
                            routes.sort((a, b) => new Date(b.date) - new Date(a.date));
                            break;
                        case 'Oldest':
                            routes.sort((a, b) => new Date(a.date) - new Date(b.date));
                            break;
                        default:
                    }
                }

                this.filteredRoutes = routes;
            },
            resetFilters() {
                this.filters.sortOption = null;
                this.applyFilters();
            },
            scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth',
                });
            }
        }
    })

    // Component for Route Cards
    app.component('route-cards', {
        props: ['routes'],
        methods: {
            openModal(route) {
                const modalElement = new bootstrap.Modal(document.getElementById(route.modalId));
                modalElement.show();
            },
            truncateText(text, length) {
                return text.length > length ? text.substring(0, length) + "..." : text;
            }
        },
        template: `
    <div class="col-md-6 mb-4" v-for="route in routes" :key="route.postId">
      <div class="card post-card" @click="openModal(route)">
        <div class="card-body d-flex flex-column flex-sm-row align-items-start">
          <div class="image-box me-3 mb-3 mb-sm-0">
            <img :src="route.image" class="img-fluid" :alt="route.title">
          </div>
          <div>
            <h5 class="card-title" style="font-weight:bold">{{ route.title }}</h5>
            <p class="card-text truncate-2-lines">{{ truncateText(route.description, 150) }}</p>
            <p class="mb-3"><strong>Distance:</strong> {{ route.distance }}</p>
            <p class="mb-3"><strong>Location:</strong> {{ route.location }}</p>
          </div>
        </div>
        <div class="card-footer text-muted">
        {{ route.timeSince }} | {{ route.likes }} Likes | {{ route.commentsList.length }} Comments
        </div>
      </div>
    </div>
  `
    });



    app.component('route-modals', {
        props: ['routes'],
        emits: ['post-comment'],
        data() {
            return {
                newCommentText: {},
                showAllComments: {},
                showCommentInput: {},
                likedRoutes: {},
                lastApiCallTime: 0,
                disabledActions: {},
                shareableLinks: {},
                showShareModal: {}
            };
        },
        methods: {
            submitComment(route) {
                const commentText = this.newCommentText[route.postId];
                if (!commentText) return;

                const currentTime = Date.now();

                if (currentTime - this.lastApiCallTime < 1000) {
                    alert('Please wait a moment before performing another action.');
                    return;
                }

                this.lastApiCallTime = currentTime;

                // Disable the comment button and show loading
                this.disableAction(route, 'comment');
                this.newCommentText[route.postId] = ''; // Clear the textarea

                // Simulate delay before adding the comment
                setTimeout(() => {
                    // Add the comment to the route's commentsList
                    this.$emit('post-comment', route, commentText);

                    // Re-enable the comment button
                    this.disabledActions[route.postId].comment = false;
                }, 1000);

                // Simulate API call to post comment (commented out)
                // axios.post(`http://your-api-endpoint.com/routes/${route.postId}/comments`, { text: commentText })
                //   .then(response => {})
                //   .catch(error => {
                //     console.error('Error posting comment:', error);
                //   });
            },
            toggleShowAllComments(route) {
                if (this.showAllComments[route.postId] === undefined) {
                    this.showAllComments[route.postId] = false;
                }
                this.showAllComments[route.postId] = !this.showAllComments[route.postId];
            },
            limitedComments(route) {
                if (this.showAllComments[route.postId]) {
                    return route.commentsList;
                } else {
                    return route.commentsList.slice(0, 4);
                }
            },
            toggleCommentInput(route) {
                if (this.showCommentInput[route.postId] === undefined) {
                    this.showCommentInput[route.postId] = true;
                } else {
                    this.showCommentInput[route.postId] = !this.showCommentInput[route.postId];
                }
            },
            likeRoute(route) {
                const currentTime = Date.now();

                if (currentTime - this.lastApiCallTime < 1000) {
                    alert('Please wait a moment before performing another action.');
                    return;
                }

                this.lastApiCallTime = currentTime;

                if (!this.likedRoutes[route.postId]) {
                    // Update liked state immediately
                    this.likedRoutes[route.postId] = true;
                    route.likes++;

                    // Simulate API call to like the post (commented out)
                    // axios.post(`http://your-api-endpoint.com/routes/${route.postId}/like`)
                    //   .then(response => {})
                    //   .catch(error => {
                    //     console.error('Error updating likes:', error);
                    //   });
                } else {
                    // Update liked state immediately
                    this.likedRoutes[route.postId] = false;
                    route.likes--;

                    // Simulate API call to unlike the post (commented out)
                    // axios.post(`http://your-api-endpoint.com/routes/${route.postId}/unlike`)
                    //   .then(response => {})
                    //   .catch(error => {
                    //     console.error('Error updating likes:', error);
                    //   });
                }

                this.disableAction(route, 'like');
            },
            shareRoute(route) {
                const currentTime = Date.now();

                if (currentTime - this.lastApiCallTime < 1000) {
                    alert('Please wait a moment before performing another action.');
                    return;
                }

                this.lastApiCallTime = currentTime;

                // Disable the share button temporarily
                this.disableAction(route, 'share');

                // Show loading indicator
                this.shareableLinks[route.postId] = 'Loading...';

                // Simulate API call to retrieve shareable link (commented out)
                // axios.post(`http://your-api-endpoint.com/routes/${route.postId}/share`)
                //   .then(response => {
                //     const shareableLink = response.data.url;
                //     this.shareableLinks[route.postId] = shareableLink;
                //   })
                //   .catch(error => {
                //     console.error('Error retrieving shareable link:', error);
                //     this.shareableLinks[route.postId] = 'Error retrieving link.';
                //   });

                // Simulate delay
                setTimeout(() => {
                    // Placeholder shareable link
                    const shareableLink = `https://example.com/routes/${route.postId}`;

                    // Set the shareable link
                    this.shareableLinks[route.postId] = shareableLink;

                    // Open the share modal
                    this.showShareModal[route.postId] = true;

                    // Re-enable the share button
                    this.disabledActions[route.postId].share = false;
                }, 1000);
            },
            copyToClipboard(route) {
                const link = this.shareableLinks[route.postId];
                navigator.clipboard.writeText(link)
                    .then(() => {
                        alert('Link copied to clipboard!');
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                    });
            },
            closeShareModal(route) {
                this.showShareModal[route.postId] = false;
            },
            disableAction(route, actionType) {
                if (!this.disabledActions[route.postId]) {
                    this.disabledActions[route.postId] = {};
                }

                this.disabledActions[route.postId][actionType] = true;

                setTimeout(() => {
                    this.disabledActions[route.postId][actionType] = false;
                }, 1000);
            }
        },

        template: `
  <div v-for="route in routes" :key="route.postId">
    <div class="modal fade" :id="route.modalId" tabindex="-1" :aria-labelledby="route.modalId + 'Label'" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header d-flex justify-content-between align-items-start">
            <div>
              <h5 class="modal-title" :id="route.modalId + 'Label'">{{ route.title }}</h5>
              <h6 class="modal-author text-muted">by {{ route.author }}</h6>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <!-- Modal Body -->
          <div class="modal-body">
                    <div id="modal-pic">
              <img :src="route.image" alt="Route Image" class="img-fluid">
            </div>
            <!-- Modal Content -->
            <p class="text-muted">Posted {{ route.timeSince }}</p>
            <p class="text-muted">{{ route.likes }} Likes | {{ route.commentsList.length }} Comments</p>
            <p><strong>Distance:</strong> {{ route.distance }}</p>
            <p>{{ route.description }}</p>
            <!-- Action Buttons -->
            <div class="d-flex justify-content-around border-top border-bottom py-3">
              <!-- Like Button -->
              <button
                class="btn btn-link p-0 action-button"
                @click="likeRoute(route)"
                :disabled="disabledActions[route.postId]?.like"
                :class="{ liked: likedRoutes[route.postId] }"
              >
                <i :class="likedRoutes[route.postId] ? 'fas fa-thumbs-up me-1' : 'far fa-thumbs-up me-1'"></i>
                <span>Like</span>
              </button>
              <!-- Comment Button -->
              <button
                class="btn btn-link p-0 action-button"
                @click="toggleCommentInput(route)"
                :disabled="disabledActions[route.postId]?.comment"
              >
                <i class="far fa-comment me-1"></i>
                <span>Comment</span>
              </button>
              <!-- Share Button -->
              <button
                class="btn btn-link p-0 action-button"
                @click="shareRoute(route)"
                :disabled="disabledActions[route.postId]?.share"
              >
                <i class="far fa-share-square me-1"></i>
                <span>Share</span>
              </button>
            </div>
            <!-- Comments Section -->
            <br>
            <h6>Comments</h6>
            <div v-if="showCommentInput[route.postId]" class="mb-3">
              <textarea
                class="form-control mb-2"
                placeholder="Add a comment..."
                rows="2"
                v-model="newCommentText[route.postId]"
              ></textarea>
              <button
                class="btn btn-primary"
                @click="submitComment(route)"
                :disabled="disabledActions[route.postId]?.comment"
              >
                <span v-if="!disabledActions[route.postId]?.comment">Post Comment</span>
                <span v-else><i class="fas fa-spinner fa-spin"></i> Posting...</span>
              </button>
            </div>
            <ul class="list-unstyled">
              <li v-for="(comment, index) in limitedComments(route)" :key="index">
                <strong>{{ comment.name }}:</strong> {{ comment.text }}
              </li>
            </ul>
            <button
              v-if="route.commentsList.length > 4"
              @click="toggleShowAllComments(route)"
              class="btn btn-link p-0"
            >
              {{ showAllComments[route.postId] ? 'Show Less Comments' : 'Load More Comments' }}
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Share Modal -->
    <div
      class="modal fade"
      :id="'shareModal' + route.modalId"
      tabindex="-1"
      :aria-labelledby="'shareModalLabel' + route.modalId"
      aria-hidden="true"
      v-if="showShareModal[route.postId]"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" :id="'shareModalLabel' + route.modalId">Share Route</h5>
            <button type="button" class="btn-close" @click="closeShareModal(route)" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Share this link with your friends:</p>
            <div class="input-group mb-3">
              <input
                type="text"
                class="form-control"
                :value="shareableLinks[route.postId]"
                readonly
              >
              <button class="btn btn-outline-secondary" type="button" @click="copyToClipboard(route)">
                Copy
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
`

    });



    app.mount('#app');
</script>


<!-- <script>
    // This JS script will allow hover to open navbar dropdown, but the dropdown menu flows out of page
    document.addEventListener('DOMContentLoaded', function () {
        // Get the dropdown element
        var dropdown = document.querySelector('.nav-item.dropdown');

        // Add event listeners for mouseenter and mouseleave
        dropdown.addEventListener('mouseenter', function () {
            var dropdownToggle = this.querySelector('.dropdown-toggle');
            var dropdownMenu = this.querySelector('.dropdown-menu');

            dropdownToggle.classList.add('show');
            dropdownMenu.classList.add('show');
        });

        dropdown.addEventListener('mouseleave', function () {
            var dropdownToggle = this.querySelector('.dropdown-toggle');
            var dropdownMenu = this.querySelector('.dropdown-menu');

            dropdownToggle.classList.remove('show');
            dropdownMenu.classList.remove('show');
        });
    });
</script> -->


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

</html>