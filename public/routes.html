<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta and Title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapPalette - Feed</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Updated CSS Styles -->
    <link rel="stylesheet" href="search.css">

    <!-- Firebase -->
    <script type="module" src="firebase.js"></script>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Axios for HTTP Requests -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body>
    <div id="app">
        <!-- Navbar -->
        <nav-bar></nav-bar>

        <!-- Feed Header -->
        <div class="sample-header">
            <div class="sample-header-section">
                <h1>Routes</h1>
                <h2>Discover, share, and engage with creative running routes.</h2>
            </div>
        </div>

        <!-- Main Content Wrapper -->
        <div class="sample-section-wrap">
            <div class="container-fluid sample-section">
                <!-- Your main content (Vue components) -->
                <div>
                    <!-- Filter, Search, and Badge Row -->
                    <div class="row align-items-center mb-2">

                        <!-- Search Input -->
                        <div class="col-4">
                            <p>Search for a route:</p>
                            <input type="text" class="form-control" v-model="searchQuery" @input="applyFilters"
                                placeholder="Route Name">
                        </div>


                        <!-- Badge (Positioned to the left of Filter Button) -->
                        <div class="col-auto ms-auto">
                            <span v-if="filters.sortOption" class="badge">
                                {{ filters.sortOption }}
                                <span @click="removeFilter()" class="ms-1">&times;</span>
                            </span>
                        </div>

                        <!-- Filter Options Button -->
                        <div class="col-auto">
                            <div class="dropdown">
                                <button class="btn filter-btn dropdown-toggle" type="button" id="filterDropdown"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    Sort By
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="filterDropdown">
                                    <!-- Sort by Distance -->
                                    <li>
                                        <h6 class="dropdown-header">Distance</h6>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Shortest')">Shortest to
                                            Longest</a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Longest')">Longest to
                                            Shortest</a>
                                    </li>

                                    <!-- Sort by Popularity -->
                                    <li>
                                        <h6 class="dropdown-header">Popularity</h6>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Most Popular')">Most
                                            Popular</a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Least Popular')">Least
                                            Popular</a>
                                    </li>

                                    <!-- Sort by Time Created -->
                                    <li>
                                        <h6 class="dropdown-header">Time Created</h6>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Newest')">Newest</a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Oldest')">Oldest</a>
                                    </li>

                                    <!-- Reset Button -->
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" @click="resetFilters()">Reset
                                            Filters</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <!-- Modals -->
                    <route-modals :routes="filteredRoutes"></route-modals>

                    <!-- Cards -->
                    <div class="row mt-4">
                        <route-cards :routes="filteredRoutes"></route-cards>
                    </div>

                    <!-- Load More Button -->
                    <div class="text-center mt-4" v-if="displayedRoutes < routes.length">
                        <button class="btn btn-outline-primary" @click="loadMoreRoutes">Load More</button>
                    </div>
                </div>
            </div>
        </div>

        <button @click="scrollToTop" class="btn back-to-top">
            <i class="fas fa-chevron-up"></i>
        </button>

        <!-- Footer -->
        <site-footer></site-footer>

    </div>




</body>


<script>
    const app = Vue.createApp({
        data() {
            return {
                isDropdownOpen: false,
                filters: {
                    sortOption: null
                },
                routes: [],
                users: [],
                filteredRoutes: [],
                displayedRoutes: 8,
                userName: 'You',
                searchQuery: '',
            };
        },
        mounted() {
                const loadingSpinner = document.getElementById('loading-spinner');
                const appContainer = document.getElementById('app-container');

                // Check every 100ms if window.currentUser is populated
                const userCheckInterval = setInterval(() => {
                    if (window.currentUser) {
                        loadingSpinner.style.display = 'none';
                        appContainer.style.display = 'block';
                        clearInterval(userCheckInterval); // Stop checking once loaded
                    }
                }, 100);
            },

        created() {
            const routesPromise = axios.get('https://app-907670644284.us-central1.run.app/api/allposts');
            const usersPromise = axios.get('https://app-907670644284.us-central1.run.app/api/api/users/getallusers');

            Promise.all([routesPromise, usersPromise])
                .then(([routesResponse, usersResponse]) => {
                    console.log('Users Data:', usersResponse.data);
                    console.log('Routes Data:', routesResponse.data);

                    this.users = usersResponse.data.users;
                    this.routes = routesResponse.data.map(route => {
                        const user = this.users.find(user => user.id === route.userID);

                        if (!user) {
                            console.warn(`User not found for route ${route.postID} with userID ${route.userID}`);
                        }

                        return {
                            ...route, // spreads route into a new object and concats new key value pairs
                            modalId: 'modal-' + route.postID,
                            timeSince: this.calculateTimeSince(route.createdAt),
                            commentsList: route.commentsList || [],
                            username: user ? user.username : 'Unknown User',
                        };  
                    });
                    this.applyFilters();
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                });
        },


        computed: {
            activeFilters() {
                return this.filters.sortOption ? [{ key: 'Sort By', value: this.filters.sortOption }] : [];
            }
        },
        methods: {
            calculateTimeSince(dateString) {
                const postDate = new Date(dateString);
                const currentDate = new Date();
                const diffInSeconds = Math.floor((currentDate - postDate) / 1000);
                const intervals = [
                    { label: 'year', seconds: 31536000 },
                    { label: 'month', seconds: 2592000 },
                    { label: 'day', seconds: 86400 },
                    { label: 'hour', seconds: 3600 },
                    { label: 'minute', seconds: 60 },
                    { label: 'second', seconds: 1 },
                ];
                for (const interval of intervals) {
                    const count = Math.floor(diffInSeconds / interval.seconds);
                    if (count >= 1) {
                        return count === 1
                            ? `1 ${interval.label} ago`
                            : `${count} ${interval.label}s ago`;
                    }
                }
                return 'Just Now';
            },
            loadMoreRoutes() {
                this.displayedRoutes += 8;
                this.applyFilters();
            },
            applyFilters() {
                let routes = [...this.routes];
                if (this.searchQuery) {
                    const lowerQuery = this.searchQuery.toLowerCase();
                    routes = routes.filter(route => route.title.toLowerCase().includes(lowerQuery));
                }
                if (this.filters.sortOption) {
                    switch (this.filters.sortOption) {
                        case 'Shortest':
                            routes.sort((a, b) => a.distance - b.distance);
                            break;
                        case 'Longest':
                            routes.sort((a, b) => b.distance - a.distance);
                            break;
                        case 'Most Popular':
                            routes.sort((a, b) => b.likeCount - a.likeCount);
                            break;
                        case 'Least Popular':
                            routes.sort((a, b) => a.likeCount - b.likeCount);
                            break;
                        case 'Newest':
                            routes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                            break;
                        case 'Oldest':
                            routes.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                            break;
                        default:
                    }
                }
                this.filteredRoutes = routes.slice(0, this.displayedRoutes);
            },
            setFilter(value) {
                this.filters.sortOption = value;
                this.displayedRoutes = 8;
                this.applyFilters();
            },
            removeFilter() {
                this.filters.sortOption = null;
                this.applyFilters();
            },
            resetFilters() {
                this.filters.sortOption = null;
                this.displayedRoutes = 8;
                this.applyFilters();
            },
            scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth',
                });
            }
        }
    });

    app.component('route-cards', {
        props: ['routes'],
        methods: {
            openModal(route) {
                const modalElement = new bootstrap.Modal(document.getElementById(route.modalId));
                modalElement.show();
            },
            truncateText(text, wordLimit) {
                const words = text.split(" ");
                return words.length > wordLimit ? words.slice(0, wordLimit).join(" ") + "..." : text;
            }
        },
        // Location will be the first waypoint's address
        template: `
<div class="col-md-6 mb-4" v-for="route in routes" :key="route.postID">
  <div class="card post-card">
    <div class="card-body d-flex">
      <!-- Image Box -->
      <div class="image-box me-3">
        <img :src="route.image" class="img-fluid" :alt="route.title">
      </div>
      <!-- Text Content -->
      <div class="text-content">
        <h5 class="card-title">{{ route.title }}</h5>
        <p class="card-text truncate-2-lines">{{  truncateText(route.description, 150) }}</p>
        <p><strong>Distance:</strong> {{ route.distance }} km</p>
        <p><strong>Location:</strong> {{ route.waypoints[0].address }}</p>
      </div>
    </div>
    <div class="card-footer text-muted">
      {{ route.timeSince }} | {{ route.likeCount }} Likes | {{ route.commentsList.length }} Comments | by {{ route.username }}
    </div>
  </div>
</div>

            `
    });

    // Component for Route Modals
    app.component('route-modals', {
        props: ['routes'],
        data() {
            return {
                newCommentText: {},
                likedRoutes: {},
                lastApiCallTime: 0,
                disabledActions: {},
                shareableLinks: {},
                showShareModal: {}
            };
        },
        methods: {
            likeRoute(route) {
                const apiEndpoint = `https://app-6kmdo5luna-uc.a.run.app/api/posts/like?id=${route.postID}`; // Dynamic endpoint
                const currentTime = Date.now();

                // Throttle to avoid rapid calls
                if (currentTime - this.lastApiCallTime < 1000) {
                    alert('Please wait a moment before liking again.');
                    return;
                }

                this.lastApiCallTime = currentTime;

                // Toggle local like state for immediate feedback
                const isLiked = this.likedRoutes[route.postID];
                this.likedRoutes[route.postID] = !isLiked;
                route.likeCount += isLiked ? -1 : 1;

                // Disable the button during the API call
                this.disableAction(route, 'like');

                // Send a POST request to update the like count in the database
                axios.post(apiEndpoint)
                    .then(response => {
                        console.log("Like updated in the database:", response.data);
                    })
                    .catch(error => {
                        console.error("Error updating like:", error);

                        // Revert like action on error
                        this.likedRoutes[route.postID] = isLiked;
                        route.likeCount += isLiked ? 1 : -1;
                        alert("Failed to update like. Please try again.");
                    });
            },
            // submitComment(route) {
            //     const commentText = this.newCommentText[route.postID];
            //     if (!commentText) return;

            //     const currentTime = Date.now();

            //     if (currentTime - this.lastApiCallTime < 1000) {
            //         alert('Please wait a moment before performing another action.');
            //         return;
            //     }

            //     this.lastApiCallTime = currentTime;

            //     // Disable the comment button and show loading
            //     this.disableAction(route, 'comment');
            //     this.newCommentText[route.postID] = ''; // Clear the textarea

            //     // Simulate delay before adding the comment
            //     setTimeout(() => {
            //         // Create a new comment object
            //         const newComment = {
            //             commenterID: 'currentUserID', // Replace with actual user ID
            //             commenterName: this.userName,
            //             commentText: commentText,
            //             timestamp: new Date().toISOString()
            //         };

            //         // Add the new comment to the route's commentsList
            //         route.commentsList.push(newComment);

            //         // Update the comment count
            //         route.commentCount = route.commentsList.length;

            //         // Re-enable the comment button
            //         this.disabledActions[route.postID].comment = false;
            //     }, 1000);
            // },
            disableAction(route, actionType) {
                if (!this.disabledActions[route.postID]) {
                    this.disabledActions[route.postID] = {};
                }

                this.disabledActions[route.postID][actionType] = true;

                setTimeout(() => {
                    this.disabledActions[route.postID][actionType] = false;
                }, 1000);
            },
            // API call for "Use" button
            useRoute(route) {
                // Define the API endpoint and payload
                const apiEndpoint = "https://api.example.com/use"; // Replace with your actual API endpoint

                // Send POST request with route's ID
                axios.post(apiEndpoint, { postID: route.postID })
                    .then(response => {
                        console.log("Route used:", response.data);
                        // Optional: provide user feedback
                    })
                    .catch(error => {
                        console.error("Error using route:", error);
                        alert("Error using route.");
                    });
                this.disableAction(route, 'use')
            },

            // API call for "Share" button
            shareRoute(route) {
                // Define the API endpoint and payload
                const apiEndpoint = "https://api.example.com/share"; // Replace with your actual API endpoint

                // Send POST request with route's ID
                axios.post(apiEndpoint, { postID: route.postID })
                    .then(response => {
                        console.log("Route shared:", response.data);
                        alert("Route shared successfully!");
                    })
                    .catch(error => {
                        console.error("Error sharing route:", error);
                        alert("Failed to share route.");
                    });
                this.disableAction(route, 'share')
            }
        },
        template: `
    <div v-for="route in routes" :key="route.postID">
      <div class="modal fade" :id="route.modalId" tabindex="-1" :aria-labelledby="route.modalId + 'Label'" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header d-flex justify-content-between align-items-start">
              <div>
                <h5 class="modal-title" :id="route.modalId + 'Label'">{{ route.title }}</h5>
                <h6 class="modal-author text-muted">by {{ route.username }}</h6>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- Modal Body -->
            <div class="modal-body">
              <div id="modal-pic">
                <img :src="route.image" alt="Route Image" class="img-fluid">
              </div>
              <!-- Modal Content -->
              <p class="text-muted">Posted {{ route.timeSince }}</p>
              <p class="text-muted">{{ route.likeCount }} Likes | {{ route.commentCount }} Comments</p>
              <p><strong>Distance:</strong> {{ route.distance }} km</p>
              <p>{{ route.description }}</p>
<!-- Action Buttons -->
<div class="d-flex justify-content-around border-top border-bottom py-3">
  <!-- Like Button -->
  <button
    class="btn btn-link p-0 action-button"
    @click="likeRoute(route)"
    :disabled="disabledActions[route.postID]?.like"
    :class="{ liked: likedRoutes[route.postID] }"
  >
    <i :class="likedRoutes[route.postID] ? 'fas fa-thumbs-up me-1' : 'far fa-thumbs-up me-1'"></i>
    <span>Like</span>
  </button>
  <!-- Use Button -->
  <button
    class="btn btn-link p-0 action-button"
    @click="useRoute(route)"
    :disabled="disabledActions[route.postID]?.use"
  >
    <i class="fas fa-route me-1"></i>
    <span>Use</span>
  </button>
  <!-- Share Button -->
  <button
    class="btn btn-link p-0 action-button"
    @click="shareRoute(route)"
    :disabled="disabledActions[route.postID]?.share"
  >
    <i class="far fa-share-square me-1"></i>
    <span>Share</span>
  </button>
</div>

              <!-- Comments Section -->
              <br>
              <h6>Comments ({{ route.commentCount }})</h6>
              <div v-if="route.commentsList && route.commentsList.length">
                <div v-for="(comment, index) in route.commentsList" :key="index" class="mb-3">
                  <strong>{{ comment.commenterName }}</strong> <span class="text-muted">{{ formatTime(comment.timestamp) }}</span>
                  <p>{{ comment.commentText }}</p>
                </div>
              </div>
              <div v-else>
                <p>No comments yet. Be the first to comment!</p>
              </div>

              <!-- Comment Input -->
              <div class="mb-3">
                <textarea
                  class="form-control mb-2"
                  placeholder="Add a comment..."
                  rows="2"
                  v-model="newCommentText[route.postID]"
                ></textarea>
                <button
                  class="btn btn-primary"
                  @click="submitComment(route)"
                  :disabled="disabledActions[route.postID]?.comment"
                >
                  <span v-if="!disabledActions[route.postID]?.comment">Post Comment</span>
                  <span v-else><i class="fas fa-spinner fa-spin"></i> Posting...</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Share Modal -->
      <div
        class="modal fade"
        :id="'shareModal' + route.modalId"
        tabindex="-1"
        :aria-labelledby="'shareModalLabel' + route.modalId"
        aria-hidden="true"
        v-if="showShareModal[route.postID]"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" :id="'shareModalLabel' + route.modalId">Share Route</h5>
              <button type="button" class="btn-close" @click="closeShareModal(route)" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Share this link with your friends:</p>
              <div class="input-group mb-3">
                <input
                  type="text"
                  class="form-control"
                  :value="shareableLinks[route.postID]"
                  readonly
                >
                <button class="btn btn-outline-secondary" type="button" @click="copyToClipboard(route)">
                  Copy
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `
    });
</script>

<script src="navbar/navbar.js"></script>

<!-- import footer from footer.js -->
<script src="footer/footer.js"></script>

<script>
    app.mount('#app')
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>


<!-- <script>
    // This JS script will allow hover to open navbar dropdown, but the dropdown menu flows out of page
    document.addEventListener('DOMContentLoaded', function () {
        // Get the dropdown element
        var dropdown = document.querySelector('.nav-item.dropdown');

        // Add event listeners for mouseenter and mouseleave
        dropdown.addEventListener('mouseenter', function () {
            var dropdownToggle = this.querySelector('.dropdown-toggle');
            var dropdownMenu = this.querySelector('.dropdown-menu');

            dropdownToggle.classList.add('show');
            dropdownMenu.classList.add('show');
        });

        dropdown.addEventListener('mouseleave', function () {
            var dropdownToggle = this.querySelector('.dropdown-toggle');
            var dropdownMenu = this.querySelector('.dropdown-menu');

            dropdownToggle.classList.remove('show');
            dropdownMenu.classList.remove('show');
        });
    });
</script> -->