<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta and Title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapPalette - Feed</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Updated CSS Styles -->
    <link rel="stylesheet" href="search.css">

    <!-- Firebase -->
    <script type="module" src="firebase.js"></script>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Axios for HTTP Requests -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body>
    <div id="app">
        <!-- Navbar -->
        <nav-bar></nav-bar>

        <!-- Feed Header -->
        <div class="sample-header">
            <div class="sample-header-section">
                <h1>Routes</h1>
                <h2>Discover, share, and engage with creative running routes.</h2>
            </div>
        </div>

        <!-- Main Content Wrapper -->
        <div class="sample-section-wrap">
            <div class="container-fluid sample-section">
                <!-- Your main content (Vue components) -->
                <div>
                    <!-- Filter, Search, and Badge Row -->
                    <div class="row align-items-center mb-2">

                        <!-- Search Input -->
                        <div class="col-4">
                            <p>Search for a route:</p>
                            <input type="text" class="form-control" v-model="searchQuery" @input="applyFilters"
                                placeholder="Route Name">
                        </div>


                        <!-- Badge (Positioned to the left of Filter Button) -->
                        <div class="col-auto ms-auto">
                            <span v-if="filters.sortOption" class="badge">
                                {{ filters.sortOption }}
                                <span @click="removeFilter()" class="ms-1">&times;</span>
                            </span>
                        </div>

                        <!-- Filter Options Button -->
                        <div class="col-auto">
                            <div class="dropdown">
                                <button class="btn filter-btn dropdown-toggle" type="button" id="filterDropdown"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    Sort By
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="filterDropdown">
                                    <!-- Sort by Distance -->
                                    <li>
                                        <h6 class="dropdown-header">Distance</h6>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Shortest')">Shortest to
                                            Longest</a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Longest')">Longest to
                                            Shortest</a>
                                    </li>

                                    <!-- Sort by Popularity -->
                                    <li>
                                        <h6 class="dropdown-header">Popularity</h6>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Most Popular')">Most
                                            Popular</a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Least Popular')">Least
                                            Popular</a>
                                    </li>

                                    <!-- Sort by Time Created -->
                                    <li>
                                        <h6 class="dropdown-header">Time Created</h6>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Newest')">Newest</a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click="setFilter('Oldest')">Oldest</a>
                                    </li>

                                    <!-- Reset Button -->
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" @click="resetFilters()">Reset
                                            Filters</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <!-- Modals -->
                    <route-modals :routes="filteredRoutes"></route-modals>

                    <!-- Cards -->
                    <div class="row mt-4">
                        <route-cards :routes="filteredRoutes"></route-cards>
                    </div>

                    <!-- Load More Button -->
                    <div class="text-center mt-4" v-if="displayedRoutes < routes.length">
                        <button class="btn btn-outline-primary" @click="loadMoreRoutes">Load More</button>
                    </div>
                </div>
            </div>
        </div>

        <button @click="scrollToTop" class="btn back-to-top">
            <i class="fas fa-chevron-up"></i>
        </button>

        <!-- Footer -->
        <site-footer></site-footer>

    </div>




</body>


<script>
    const app = Vue.createApp({
        data() {
            return {
                isDropdownOpen: false,
                filters: {
                    sortOption: null
                },
                routes: [],
                users: [],
                filteredRoutes: [],
                displayedRoutes: 8,
                userName: 'You',
                searchQuery: '',
            };
        },
        mounted() {
            const loadingSpinner = document.getElementById('loading-spinner');
            const appContainer = document.getElementById('app-container');

            // Check every 100ms if window.currentUser is populated
            const userCheckInterval = setInterval(() => {
                if (window.currentUser) {
                    loadingSpinner.style.display = 'none';
                    appContainer.style.display = 'block';
                    clearInterval(userCheckInterval); // Stop checking once loaded
                }
            }, 100);
        },

        created() {
            axios.get('https://app-907670644284.us-central1.run.app/api/allposts')
                .then(response => {
                    this.routes = response.data.map(route => ({
                        ...route,
                        modalId: 'modal-' + route.postID,
                        timeSince: this.calculateTimeSince(new Date(route.createdAt._seconds * 1000)),
                        username: '', // Placeholder for now
                    }));

                    // Extract unique user IDs from routes
                    const userIDs = [...new Set(this.routes.map(route => route.userID))];

                    // Fetch user data for each unique userID
                    const userPromises = userIDs.map(id =>
                        axios.get(`https://app-907670644284.us-central1.run.app/api/${id}`)
                            .then(userResponse => ({
                                id,
                                username: userResponse.data.username // Adjust property as needed
                            }))
                    );

                    // Populate routes with user data once all user data is fetched
                    Promise.all(userPromises).then(users => {
                        this.routes.forEach(route => {
                            const user = users.find(user => user.id === route.userID);
                            if (user) {
                                route.username = user.username;
                            }
                        });
                        this.applyFilters();
                    }).catch(error => {
                        console.error("Error fetching user data:", error);
                    });
                })
                .catch(error => {
                    console.error("Error fetching routes data:", error);
                });
        },

        computed: {
            activeFilters() {
                return this.filters.sortOption ? [{ key: 'Sort By', value: this.filters.sortOption }] : [];
            }
        },
        methods: {
            calculateTimeSince(dateString) {
                const postDate = new Date(dateString);
                const currentDate = new Date();
                const diffInSeconds = Math.floor((currentDate - postDate) / 1000);
                const intervals = [
                    { label: 'year', seconds: 31536000 },
                    { label: 'month', seconds: 2592000 },
                    { label: 'day', seconds: 86400 },
                    { label: 'hour', seconds: 3600 },
                    { label: 'minute', seconds: 60 },
                    { label: 'second', seconds: 1 },
                ];
                for (const interval of intervals) {
                    const count = Math.floor(diffInSeconds / interval.seconds);
                    if (count >= 1) {
                        return count === 1
                            ? `1 ${interval.label} ago`
                            : `${count} ${interval.label}s ago`;
                    }
                }
                return 'Just Now';
            },
            loadMoreRoutes() {
                this.displayedRoutes += 8;
                this.applyFilters();
            },
            applyFilters() {
                let routes = [...this.routes];
                if (this.searchQuery) {
                    const lowerQuery = this.searchQuery.toLowerCase();
                    routes = routes.filter(route => route.title.toLowerCase().includes(lowerQuery));
                }
                if (this.filters.sortOption) {
                    switch (this.filters.sortOption) {
                        case 'Shortest':
                            routes.sort((a, b) => a.distance - b.distance);
                            break;
                        case 'Longest':
                            routes.sort((a, b) => b.distance - a.distance);
                            break;
                        case 'Most Popular':
                            routes.sort((a, b) => b.likeCount - a.likeCount);
                            break;
                        case 'Least Popular':
                            routes.sort((a, b) => a.likeCount - b.likeCount);
                            break;
                        case 'Newest':
                            routes.sort((a, b) => new Date(b.createdAt._seconds * 1000) - new Date(a.createdAt._seconds * 1000));
                            break;
                        case 'Oldest':
                            routes.sort((a, b) => new Date(a.createdAt._seconds * 1000) - new Date(b.createdAt._seconds * 1000));
                            break;
                        default:
                            break;
                    }
                }
                this.filteredRoutes = routes.slice(0, this.displayedRoutes);

            },
            setFilter(value) {
                this.filters.sortOption = value;
                this.displayedRoutes = 8;
                this.applyFilters();
            },
            removeFilter() {
                this.filters.sortOption = null;
                this.applyFilters();
            },
            resetFilters() {
                this.filters.sortOption = null;
                this.displayedRoutes = 8;
                this.applyFilters();
            },
            scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth',
                });
            }
        }
    });

    app.component('route-cards', {
        props: ['routes'],

        methods: {
            openModal(route) {
                const modalElement = new bootstrap.Modal(document.getElementById(route.modalId));
                modalElement.show();
            },
            truncateText(text, wordLimit) {
                const words = text.split(" ");
                return words.length > wordLimit ? words.slice(0, wordLimit).join(" ") + "..." : text;
            }
        },
        // Location will be the first waypoint's address
        template: `
<div class="col-md-6 mb-4" v-for="route in routes" :key="route.postID">
  <div class="card post-card" @click="openModal(route)">
    <div class="card-body d-flex">
      <div class="image-box me-3">
        <img :src="route.image" class="img-fluid" :alt="route.title">
      </div>
      <div class="text-content">
        <h5 class="card-title">{{ route.title }}</h5>
        <p class="card-text">{{ route.description }}</p>
        <p><strong>Distance:</strong> {{ route.distance }} km</p>
        <p><strong>Location:</strong> {{ route.waypoints.length > 0 ? route.waypoints[0].address : 'N/A' }}</p>
      </div>
    </div>
    <div class="card-footer text-muted">
      {{ route.timeSince }} | {{ route.likeCount }} Likes
    </div>
  </div>
</div>


            `
    });

    // Component for Route Modals
    app.component('route-modals', {
        props: ['routes'],
        data() {
            return {
                newCommentText: {},
                likedRoutes: {},
                lastApiCallTime: 0,
                disabledActions: {},
                shareableLinks: {},
                showShareModal: {}
            };
        },
        methods: {
            likeRoute(route) {
                const currentUserID = window.currentUser?.id || 'defaultUserID'; // Replace with your actual method for fetching the current user ID.
                const endpoint = this.likedRoutes[route.postID]
                    ? `https://app-907670644284.us-central1.run.app/api/posts/unlike`
                    : `https://app-907670644284.us-central1.run.app/api/posts/like`;

                console.log(route.postID, currentUserID)

                // Construct the request payload with both postID and userID
                const payload = {
                    postID: route.postID,
                    userID: currentUserID
                };

                axios.post(endpoint, payload)
                    .then(response => {
                        console.log("Like/unlike updated successfully:", response.data);
                    })
                    .catch(error => {
                        console.error("Error updating like/unlike:", error);

                        // Log server response for better insights
                        if (error.response) {
                            console.error("Server response:", error.response.data);
                        }

                        // Revert like action on error
                        const isLiked = this.likedRoutes[route.postID];
                        this.likedRoutes[route.postID] = isLiked;
                        route.likeCount += isLiked ? 1 : -1;
                        alert("Failed to update like/unlike. Please try again.");
                    });
            }
            ,
            submitComment(route) {
                const commentText = this.newCommentText[route.postID];
                if (!commentText) return;  // Exit if no comment text

                const currentUserID = window.currentUser?.id || 'defaultUserID';  // Replace with actual user ID logic

                // Disable the comment button while posting
                this.disabledActions[route.postID] = { comment: true };

                // POST request to submit the comment - backend issue need to fix
                axios.post(`https://app-907670644284.us-central1.run.app/api/posts/${route.postID}/comments`, {
                    userID: currentUserID,
                    text: commentText
                })
                    .then(response => {
                        console.log('Comment posted successfully:', response.data);

                        // Add the new comment locally to the route's comments list
                        if (!route.commentsList) {
                            route.commentsList = [];
                        }
                        route.commentsList.push({
                            commenterName: 'You',  // Display name for the current user
                            commentText: commentText,
                            timestamp: new Date().toISOString()  // Current timestamp
                        });

                        // Clear the input field after posting
                        this.newCommentText[route.postID] = '';
                    })
                    .catch(error => {
                        console.error('Error posting comment:', error);
                        alert('Failed to post comment. Please try again.');

                        // Log detailed error information
                        if (error.response) {
                            console.error('Server responded with:', error.response.data);
                        }
                        this.disabledActions[route.postID].comment = false;
                    });
            }
            ,
            formatTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleString();  // Adjust formatting as needed
            },
            disableAction(route, actionType) {
                if (!this.disabledActions[route.postID]) {
                    this.disabledActions[route.postID] = {};
                }

                this.disabledActions[route.postID][actionType] = true;

                setTimeout(() => {
                    this.disabledActions[route.postID][actionType] = false;
                }, 1000);
            },
            // API call for "Use" button
            useRoute(route) {
                // Define the API endpoint and payload
                const apiEndpoint = "https://api.example.com/use"; // Replace with your actual API endpoint

                // Send POST request with route's ID
                axios.post(apiEndpoint, { postID: route.postID })
                    .then(response => {
                        console.log("Route used:", response.data);
                        // Optional: provide user feedback
                    })
                    .catch(error => {
                        console.error("Error using route:", error);
                        alert("Error using route.");
                    });
                this.disableAction(route, 'use')
            },

            // API call for "Share" button
            shareRoute(route) {
                // Define the API endpoint and payload
                const apiEndpoint = "https://api.example.com/share"; // Replace with your actual API endpoint

                // Send POST request with route's ID
                axios.post(apiEndpoint, { postID: route.postID })
                    .then(response => {
                        console.log("Route shared:", response.data);
                        alert("Route shared successfully!");
                    })
                    .catch(error => {
                        console.error("Error sharing route:", error);
                        alert("Failed to share route.");
                    });
                this.disableAction(route, 'share')
            }
        },
        template: `
    <div v-for="route in routes" :key="route.postID">
      <div class="modal fade" :id="route.modalId" tabindex="-1" :aria-labelledby="route.modalId + 'Label'" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header d-flex justify-content-between align-items-start">
              <div>
                <h5 class="modal-title" :id="route.modalId + 'Label'">{{ route.title }}</h5>
                <h6 class="modal-author text-muted">by {{ route.username }}</h6>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="modal-pic">
                <img :src="route.image" alt="Route Image" class="img-fluid">
              </div>
              <p class="text-muted">Posted {{ route.timeSince }}</p>
              <p class="text-muted">{{ route.likeCount }} Likes | {{ route.commentCount }} Comments</p>
              <p><strong>Distance:</strong> {{ route.distance }} km</p>
              <p>{{ route.description }}</p>
              <div class="d-flex justify-content-around border-top border-bottom py-3">
                <!-- Action Buttons (Like, Use, Share) -->
                <button class="btn btn-link p-0 action-button" @click="likeRoute(route)">
                  <i class="far fa-thumbs-up me-1"></i>
                  <span>Like</span>
                </button>
                <button class="btn btn-link p-0 action-button" @click="useRoute(route)">
                  <i class="fas fa-route me-1"></i>
                  <span>Use</span>
                </button>
                <button class="btn btn-link p-0 action-button" @click="shareRoute(route)">
                  <i class="far fa-share-square me-1"></i>
                  <span>Share</span>
                </button>
              </div>
              <br>
              <h6>Comments ({{ route.commentsList ? route.commentsList.length : 0 }})</h6>
              <div v-if="route.commentsList && route.commentsList.length">
                <div v-for="(comment, index) in route.commentsList" :key="index" class="mb-3">
                  <strong>{{ comment.commenterName }}</strong>
                  <span class="text-muted">{{ formatTime(comment.timestamp) }}</span>
                  <p>{{ comment.commentText }}</p>
                </div>
              </div>
              <div v-else>
                <p>No comments yet. Be the first to comment!</p>
              </div>
              <div class="mb-3">
                <textarea class="form-control mb-2" placeholder="Add a comment..." rows="2" v-model="newCommentText[route.postID]"></textarea>
                <button class="btn btn-primary" @click="submitComment(route)" :disabled="disabledActions[route.postID]?.comment">
                  <span v-if="!disabledActions[route.postID]?.comment">Post Comment</span>
                  <span v-else><i class="fas fa-spinner fa-spin"></i> Posting...</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `
    });
</script>

<script src="navbar/navbar.js"></script>

<!-- import footer from footer.js -->
<script src="footer/footer.js"></script>

<script>
    app.mount('#app')
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>


<!-- <script>
    // This JS script will allow hover to open navbar dropdown, but the dropdown menu flows out of page
    document.addEventListener('DOMContentLoaded', function () {
        // Get the dropdown element
        var dropdown = document.querySelector('.nav-item.dropdown');

        // Add event listeners for mouseenter and mouseleave
        dropdown.addEventListener('mouseenter', function () {
            var dropdownToggle = this.querySelector('.dropdown-toggle');
            var dropdownMenu = this.querySelector('.dropdown-menu');

            dropdownToggle.classList.add('show');
            dropdownMenu.classList.add('show');
        });

        dropdown.addEventListener('mouseleave', function () {
            var dropdownToggle = this.querySelector('.dropdown-toggle');
            var dropdownMenu = this.querySelector('.dropdown-menu');

            dropdownToggle.classList.remove('show');
            dropdownMenu.classList.remove('show');
        });
    });
</script> -->